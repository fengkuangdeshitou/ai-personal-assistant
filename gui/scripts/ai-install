#!/bin/bash

# AI ç§äººåŠ©ç† - ä¸€é”®å®‰è£…è„šæœ¬
# è‡ªåŠ¨å®‰è£…æ‰€æœ‰å¿…è¦çš„ä¾èµ–å’Œé…ç½®

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ðŸ¤– AI ç§äººåŠ©ç† - ä¸€é”®å®‰è£…"
echo "================================"
echo ""

# æ£€æŸ¥æ“ä½œç³»ç»Ÿ
if [[ "$OSTYPE" != "darwin"* ]]; then
    echo "âŒ æ­¤è„šæœ¬ä»…æ”¯æŒ macOS ç³»ç»Ÿ"
    exit 1
fi

# æ£€æŸ¥ Homebrew æ˜¯å¦å®‰è£…
if ! command -v brew &> /dev/null; then
    echo "ðŸ“¦ å®‰è£… Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" << EOF
wang409744573
wang409744573
EOF
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# å®‰è£… Node.js (å¦‚æžœæœªå®‰è£…)
if ! command -v node &> /dev/null; then
    echo "ðŸ“¦ å®‰è£… Node.js..."
    echo "wang409744573" | brew install node
fi

# æ£€æŸ¥ Node.js ç‰ˆæœ¬
NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 16 ]; then
    echo "âš ï¸  Node.js ç‰ˆæœ¬è¿‡ä½Žï¼Œå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬..."
    echo "wang409744573" | brew upgrade node
fi

# å®‰è£… GitHub CLI (å¦‚æžœæœªå®‰è£…)
if ! command -v gh &> /dev/null; then
    echo "ðŸ“¦ å®‰è£… GitHub CLI..."
    echo "wang409744573" | brew install gh
fi

# å®‰è£… watchman (ç”¨äºŽ React å¼€å‘)
if ! command -v watchman &> /dev/null; then
    echo "ðŸ“¦ å®‰è£… watchman..."
    echo "wang409744573" | brew install watchman
fi

# è¿›å…¥é¡¹ç›®ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
cd "$PROJECT_DIR"

echo "ðŸ“ é¡¹ç›®ç›®å½•: $PROJECT_DIR"

# åˆ›å»ºæ—¥å¿—ç›®å½•
echo "ðŸ“ åˆ›å»ºæ—¥å¿—ç›®å½•..."
mkdir -p ~/.ai-assistant/logs

# å®‰è£…å‰ç«¯ä¾èµ–
echo "ðŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
cd frontend
if [ ! -d "node_modules" ]; then
    npm install
fi

# æž„å»ºå‰ç«¯
echo "ðŸ”¨ æž„å»ºå‰ç«¯åº”ç”¨..."
npm run build

# å®‰è£…åŽç«¯ä¾èµ–
echo "ðŸ“¦ å®‰è£…åŽç«¯ä¾èµ–..."
cd ../server
if [ ! -d "node_modules" ]; then
    npm install
fi

# åˆ›å»ºå¿…è¦çš„é…ç½®æ–‡ä»¶
echo "âš™ï¸  åˆ›å»ºé…ç½®æ–‡ä»¶..."
cd "$PROJECT_DIR"

# åˆ›å»º .env æ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
if [ ! -f "server/.env" ]; then
    cat > server/.env << EOF
# AI ç§äººåŠ©ç† - çŽ¯å¢ƒé…ç½®
PORT=5178
NODE_ENV=production

# GitHub é…ç½® (å¯é€‰)
# GITHUB_TOKEN=your_github_token_here

# é˜¿é‡Œäº‘é…ç½® (å¯é€‰)
# ALICLOUD_ACCESS_KEY_ID=your_access_key
# ALICLOUD_ACCESS_KEY_SECRET=your_secret
EOF
    echo "âœ… å·²åˆ›å»º server/.env é…ç½®æ–‡ä»¶"
fi

# è®¾ç½®æ‰§è¡Œæƒé™
echo "ðŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
chmod +x scripts/*.sh
chmod +x server/*.sh
chmod +x AIåŠ©ç†.command

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ï¼ˆå¯é€‰ï¼‰
read -p "â“ æ˜¯å¦åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ï¼Ÿ(y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ðŸ–¥ï¸  åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    ln -sf "$PROJECT_DIR/AIåŠ©ç†.command" ~/Desktop/
    echo "âœ… æ¡Œé¢å¿«æ·æ–¹å¼å·²åˆ›å»º"
fi

echo ""
echo "ðŸŽ‰ å®‰è£…å®Œæˆï¼"
echo ""
echo "ðŸš€ å¯åŠ¨æ–¹å¼ï¼š"
echo "   1. åŒå‡»æ¡Œé¢ä¸Šçš„ 'AIåŠ©ç†' å›¾æ ‡"
echo "   2. æˆ–è¿è¡Œ: ./scripts/launch.sh"
echo "   3. æˆ–è¿è¡Œ: åŠ©ç† (å¦‚æžœå·²æ·»åŠ åˆ° PATH)"
echo ""
echo "ðŸ“– æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md"