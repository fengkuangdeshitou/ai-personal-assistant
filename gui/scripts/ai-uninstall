#!/bin/bash

# AI ç§äººåŠ©ç† - ä¸€é”®å¸è½½è„šæœ¬
# æ¸…ç†æ‰€æœ‰å®‰è£…çš„æ–‡ä»¶å’Œé…ç½®

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ğŸ—‘ï¸  AI ç§äººåŠ©ç† - ä¸€é”®å¸è½½"
echo "================================"
echo ""

# è¿›å…¥é¡¹ç›®ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
cd "$PROJECT_DIR"

echo "ğŸ“ é¡¹ç›®ç›®å½•: $PROJECT_DIR"

# åœæ­¢è¿è¡Œä¸­çš„è¿›ç¨‹
echo "ğŸ›‘ åœæ­¢è¿è¡Œä¸­çš„æœåŠ¡..."

# åœæ­¢åç«¯æœåŠ¡
if lsof -i :5178 > /dev/null 2>&1; then
    echo "åœæ­¢åç«¯æœåŠ¡..."
    pkill -f "node server.js" || true
fi

# åœæ­¢å‰ç«¯æœåŠ¡
if pgrep -f "react-scripts" > /dev/null 2>&1; then
    echo "åœæ­¢å‰ç«¯æœåŠ¡..."
    pkill -f "react-scripts" || true
fi

# åœæ­¢æ¡Œé¢æé†’æœåŠ¡
if pgrep -f "reminder" > /dev/null 2>&1; then
    echo "åœæ­¢æ¡Œé¢æé†’æœåŠ¡..."
    pkill -f "reminder" || true
fi

# åˆ é™¤æ—¥å¿—æ–‡ä»¶
echo "ğŸ—‚ï¸  åˆ é™¤æ—¥å¿—æ–‡ä»¶..."
rm -rf ~/.ai-assistant/logs
rm -f /tmp/ai-assistant-*.log

# åˆ é™¤å‰ç«¯æ„å»ºæ–‡ä»¶å’Œä¾èµ–
echo "ğŸ§¹ æ¸…ç†å‰ç«¯æ–‡ä»¶..."
cd frontend
rm -rf node_modules
rm -rf build
rm -rf .cache
rm -f npm-debug.log*
rm -f yarn-error.log*

# åˆ é™¤åç«¯ä¾èµ–
echo "ğŸ§¹ æ¸…ç†åç«¯æ–‡ä»¶..."
cd ../server
rm -rf node_modules
rm -f npm-debug.log*
rm -f yarn-error.log*
rm -f server.log

# åˆ é™¤é…ç½®æ–‡ä»¶ï¼ˆä¿ç•™ç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®ï¼‰
echo "âš™ï¸  æ¸…ç†é…ç½®æ–‡ä»¶..."
cd "$PROJECT_DIR"

# è¯¢é—®æ˜¯å¦åˆ é™¤ç”¨æˆ·é…ç½®æ–‡ä»¶
read -p "â“ æ˜¯å¦åˆ é™¤é…ç½®æ–‡ä»¶ (.env, *-config.json)? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "åˆ é™¤é…ç½®æ–‡ä»¶..."
    rm -f server/.env
    rm -f server/*-config.json
    echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ é™¤"
else
    echo "â„¹ï¸  é…ç½®æ–‡ä»¶ä¿ç•™"
fi

# åˆ é™¤æ¡Œé¢å¿«æ·æ–¹å¼
echo "ğŸ–¥ï¸  åˆ é™¤æ¡Œé¢å¿«æ·æ–¹å¼..."
rm -f ~/Desktop/AIåŠ©ç†.command

# åˆ é™¤ LaunchAgentsï¼ˆå¦‚æœå­˜åœ¨ï¼‰
echo "ğŸ”§ æ¸…ç† LaunchAgents..."
rm -f ~/Library/LaunchAgents/com.ai-assistant.reminder.plist

# å¯é€‰ï¼šå¸è½½é€šè¿‡ brew å®‰è£…çš„è½¯ä»¶
read -p "â“ æ˜¯å¦å¸è½½é€šè¿‡æ­¤è„šæœ¬å®‰è£…çš„è½¯ä»¶ (Node.js, GitHub CLI, watchman)? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "âš ï¸  è­¦å‘Š: è¿™å¯èƒ½ä¼šå½±å“å…¶ä»–ä½¿ç”¨ç›¸åŒè½¯ä»¶çš„é¡¹ç›®"
    read -p "ç¡®è®¤å¸è½½ï¼Ÿ(y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "å¸è½½è½¯ä»¶..."
        echo "wang409744573" | brew uninstall node || true
        echo "wang409744573" | brew uninstall gh || true
        echo "wang409744573" | brew uninstall watchman || true
        echo "âœ… è½¯ä»¶å·²å¸è½½"
    fi
else
    echo "â„¹ï¸  ä¿ç•™å·²å®‰è£…çš„è½¯ä»¶"
fi

# åˆ é™¤é¡¹ç›®ç›®å½•ï¼ˆå¯é€‰ï¼‰
read -p "â“ æ˜¯å¦åˆ é™¤æ•´ä¸ªé¡¹ç›®ç›®å½•ï¼Ÿ(y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ğŸ—‘ï¸  åˆ é™¤é¡¹ç›®ç›®å½•..."
    cd /
    rm -rf "$PROJECT_DIR"
    echo "âœ… é¡¹ç›®å·²å®Œå…¨åˆ é™¤"
    echo ""
    echo "ğŸ‘‹ å¸è½½å®Œæˆï¼æ„Ÿè°¢ä½¿ç”¨ AI ç§äººåŠ©ç†ã€‚"
    exit 0
fi

echo ""
echo "ğŸ§¹ å¸è½½å®Œæˆï¼"
echo ""
echo "â„¹ï¸  é¡¹ç›®æ–‡ä»¶ä¿ç•™åœ¨: $PROJECT_DIR"
echo "â„¹ï¸  å¦‚éœ€é‡æ–°å®‰è£…ï¼Œè¯·è¿è¡Œ: ./scripts/ai-install"