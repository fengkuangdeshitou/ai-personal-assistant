# 生产环境压缩包上传功能

## 功能概述

生产环境现在默认使用压缩包上传方式，将整个build目录压缩成单个ZIP文件后上传，大大提高上传效率和成功率。

## 主要特性

### 🚀 自动压缩上传
- 生产环境(`prod`)自动启用压缩包上传
- 开发环境(`dev`)可手动选择是否压缩
- 支持实时压缩进度显示

### 📦 智能部署任务
生产环境上传完成后，系统会自动执行以下部署后任务：

1. **部署通知**: 发送部署完成通知
2. **版本更新**: 记录部署版本信息
3. **部署脚本**: 执行项目中的部署脚本（如存在）
4. **清理缓存**: 清理旧版本文件

### 📊 进度显示优化
- 压缩阶段：显示压缩进度(0-100%)
- 上传阶段：显示每个存储桶的独立进度
- 部署任务：显示部署后任务执行状态

## 使用方法

### 前端操作
1. 选择项目
2. 选择环境（生产环境自动启用压缩包上传）
3. 点击"构建并上传"或"直接上传"
4. 观察实时进度：
   - 压缩进度
   - 各存储桶上传进度
   - 部署任务执行状态

### 部署脚本
在项目根目录创建 `deploy.sh` 或 `scripts/deploy.sh` 脚本，系统会在生产环境上传完成后自动执行。

示例脚本内容：
```bash
#!/bin/bash
echo "执行生产环境部署任务..."
# 你的部署逻辑
```

## 配置说明

### 服务器端配置
- 自动检测生产环境并启用压缩上传
- 支持多存储桶并行上传
- 自动清理临时压缩文件

### 版本管理
系统会自动维护 `project-versions.json` 文件，记录每次部署信息：
```json
{
  "project-name": {
    "lastDeployed": "2025-11-14T03:50:00.000Z",
    "zipFile": "project-name-prod-2025-11-14T03-50-00-000Z.zip",
    "environment": "prod",
    "timestamp": 1731556200000
  }
}
```

## 技术实现

### 压缩算法
- 使用 `archiver` 库进行ZIP压缩
- 压缩级别设为最高(9级)
- 支持大文件压缩

### 进度跟踪
- Server-Sent Events (SSE) 实时进度推送
- 独立bucket进度计算
- 压缩和上传阶段分离显示

### 错误处理
- 压缩失败自动清理临时文件
- 上传失败记录详细错误信息
- 部署任务失败不影响上传成功状态

## 优势

1. **效率提升**: 单个ZIP文件比多个小文件上传更快
2. **成功率提高**: 减少网络传输中的文件数量，降低失败概率
3. **自动化**: 生产环境一键部署，自动执行后续任务
4. **可观测性**: 实时进度显示，详细的执行日志
5. **可靠性**: 完善的错误处理和资源清理机制

## 注意事项

- 确保项目build目录存在且不为空
- 部署脚本执行时间不宜过长（默认30秒超时）
- 生产环境会自动清理临时文件
- 建议定期检查版本历史文件大小