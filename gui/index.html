<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– AI ç§äººåŠ©ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 30px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .sidebar-header h2 {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .sidebar-header .version {
            color: #999;
            font-size: 0.9em;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 10px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-link .icon {
            font-size: 1.5em;
            margin-right: 12px;
            min-width: 25px;
        }

        .nav-link .text {
            flex: 1;
        }

        .content-area {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
            min-height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .greeting {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .greeting h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .greeting .time {
            color: #666;
            font-size: 1em;
        }

        .section {
            margin-bottom: 30px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            padding-left: 15px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.95em;
        }

        .work-summary {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
        }

        .work-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .work-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .work-item:last-child {
            margin-bottom: 0;
        }

        .work-item .time {
            color: #667eea;
            font-weight: bold;
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .work-item .desc {
            color: #333;
            line-height: 1.5;
        }

        /* é¡¹ç›®åˆ—è¡¨é¡¹æ ·å¼ */
        .project-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
        }

        .project-item .time {
            font-size: 1.5em;
            margin-bottom: 0;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .project-item .desc {
            flex: 1;
            margin-right: 15px;
        }

        /* é¡¹ç›®æ“ä½œæŒ‰é’®ç»„ */
        .project-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .project-item:hover .project-actions {
            opacity: 1;
        }

        .action-btn {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .action-btn:hover span {
            filter: brightness(0) invert(1);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn span {
            display: inline-block;
            transition: filter 0.2s;
        }

        .channel-selector {
            position: relative;
            display: inline-block;
        }

        .channel-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .channel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .channel-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            display: none;
            overflow: hidden;
        }

        .channel-dropdown.show {
            display: block;
            animation: fadeInDown 0.3s;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .channel-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .channel-item:last-child {
            border-bottom: none;
        }

        .channel-item:hover {
            background: #f8f9ff;
        }

        .channel-item .channel-name {
            font-weight: 500;
            color: #333;
        }

        .channel-item .channel-id {
            font-size: 0.85em;
            color: #999;
            margin-top: 2px;
        }

        .build-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
        }

        .build-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.5);
        }

        .build-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .project-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            background: #f0f0f0;
            color: #666;
        }

        .status-badge.modified {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.added {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.deleted {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.clean {
            background: #d1ecf1;
            color: #0c5460;
        }

        .project-time {
            color: #999;
            font-size: 0.9em;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            margin: 20px 0;
        }

        .chart-bar {
            flex: 1;
            margin: 0 5px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s;
            min-height: 20px;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
            font-weight: bold;
            color: #667eea;
        }

        .menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .menu-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            border: none;
            text-align: center;
            transition: all 0.3s;
            font-size: 1em;
        }

        .menu-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .menu-item .icon {
            font-size: 2.5em;
            display: block;
            margin-bottom: 10px;
        }

        .menu-item .title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .menu-item .desc {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            padding: 30px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .footer a {
            color: white !important;
            text-decoration: none;
            font-weight: bold;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            max-height: 300px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 80%;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .chat-message.assistant {
            background: white;
            color: #333;
            margin-right: auto;
            border: 1px solid #e0e0e0;
        }

        .chat-message .role {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85em;
            opacity: 0.8;
        }

        .chat-message .content {
            line-height: 1.6;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block !important;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .sidebar-footer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 0.85em;
            color: #999;
        }

        /* ç¾åŒ–å¼¹æ¡†æ ·å¼ */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 10000;
            animation: modalFadeIn 0.3s ease-out;
        }

        .custom-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.5em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(80vh - 150px);
            overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .env-check-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .env-check-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .env-check-icon {
            font-size: 1.8em;
            margin-right: 15px;
            min-width: 35px;
            text-align: center;
        }

        .env-check-content {
            flex: 1;
        }

        .env-check-label {
            font-weight: 600;
            color: #333;
            font-size: 1.05em;
            margin-bottom: 5px;
        }

        .env-check-value {
            color: #666;
            font-size: 0.95em;
            word-break: break-all;
        }

        .env-check-status {
            font-size: 1.5em;
            margin-left: 10px;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-footer-text {
            color: #666;
            font-size: 0.9em;
        }

        .modal-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .modal-button:active {
            transform: translateY(0);
        }

        .command-box {
            background: #2d3748;
            color: #48bb78;
            padding: 15px 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            margin-top: 15px;
            position: relative;
            overflow-x: auto;
        }

        .command-box code {
            display: block;
            white-space: pre-wrap;
        }

        .copy-command-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-command-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body>
    <div class="main-layout">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¤– AI åŠ©ç†</h2>
                <p class="version">v1.5.0 Plus</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showSection('dashboard', this)">
                        <span class="icon">ğŸ </span>
                        <span class="text">å·¥ä½œå°</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('chat', this)">
                        <span class="icon">ğŸ’¬</span>
                        <span class="text">AI å¯¹è¯</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('projects', this)">
                        <span class="icon">ğŸ“Š</span>
                        <span class="text">é¡¹ç›®ç®¡ç†</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('statistics', this)">
                        <span class="icon">ğŸ“ˆ</span>
                        <span class="text">æ•°æ®ç»Ÿè®¡</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('timeline', this)">
                        <span class="icon">â°</span>
                        <span class="text">å·¥ä½œè®°å½•</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('tools', this)">
                        <span class="icon">ğŸ”§</span>
                        <span class="text">å¿«é€Ÿå·¥å…·</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('settings', this)">
                        <span class="icon">âš™ï¸</span>
                        <span class="text">è®¾ç½®</span>
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <p>ç–¯ç‹‚çš„çŸ³å¤´</p>
                <p style="margin-top: 5px;">ğŸš€ è®©å¼€å‘æ›´æ™ºèƒ½</p>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="content-area">
            <!-- å·¥ä½œå° -->
            <div id="dashboard" class="content-section active">
                <div class="header">
                    <h1>ğŸ¤– AI ç§äººåŠ©ç†</h1>
                    <p class="subtitle">æ‚¨çš„æ™ºèƒ½å¼€å‘ä¼™ä¼´ v1.6.0</p>
                </div>

                <div class="greeting">
                    <h2 id="greeting">ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œç–¯ç‹‚çš„çŸ³å¤´ï¼</h2>
                    <p class="time" id="time"></p>
                </div>

                <!-- ä»Šæ—¥ç»Ÿè®¡ -->
                <div class="section">
                    <h3 class="section-title">ğŸ“Š ä»Šæ—¥å·¥ä½œç»Ÿè®¡ <button class="refresh-btn" onclick="loadStats()">ğŸ”„ åˆ·æ–°</button>
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="icon">ğŸ“</div>
                            <div class="value" id="commits">3</div>
                            <div class="label">ä»Šæ—¥æäº¤</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">â•</div>
                            <div class="value" id="insertions">245</div>
                            <div class="label">æ–°å¢ä»£ç è¡Œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">â–</div>
                            <div class="value" id="deletions">12</div>
                            <div class="label">åˆ é™¤ä»£ç è¡Œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">â°</div>
                            <div class="value" id="work-hours">8</div>
                            <div class="label">å·¥ä½œæ—¶é•¿(å°æ—¶)</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ“</div>
                            <div class="value">26</div>
                            <div class="label">é¡¹ç›®æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ”¥</div>
                            <div class="value" id="productivity">85%</div>
                            <div class="label">ç”Ÿäº§åŠ›</div>
                        </div>
                    </div>
                </div>

                <!-- æœ¬å‘¨è¶‹åŠ¿ -->
                <div class="section">
                    <h3 class="section-title">ğŸ“ˆ æœ¬å‘¨ä»£ç è¶‹åŠ¿</h3>
                    <div class="chart-container">
                        <div class="chart-bars" id="weeklyChart">
                            <!-- é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨ä¸€</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨äºŒ</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨ä¸‰</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨å››</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨äº”</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨å…­</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨æ—¥</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI å¯¹è¯ -->
            <div id="chat" class="content-section">
                <div class="section">
                    <h3 class="section-title">ğŸ’¬ AI å¯¹è¯åŠ©æ‰‹</h3>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message assistant">
                                <div class="role">ğŸ¤– AI åŠ©ç†</div>
                                <div class="content">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI ç§äººåŠ©ç†ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" id="chatInput" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯... (ä¾‹å¦‚ï¼šå¸®æˆ‘æ£€æŸ¥é¡¹ç›®çŠ¶æ€)"
                                onkeypress="if(event.key==='Enter') sendMessage()">
                            <button class="chat-send-btn" onclick="sendMessage()">å‘é€</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é¡¹ç›®ç®¡ç† -->
            <div id="projects" class="content-section">
                <div class="section">
                    <h3 class="section-title">ğŸ“Š æˆ‘çš„é¡¹ç›®</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="icon">ğŸ“</div>
                            <div class="value">26</div>
                            <div class="label">é¡¹ç›®æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ”¥</div>
                            <div class="value">12</div>
                            <div class="label">æ´»è·ƒé¡¹ç›®</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">âœ…</div>
                            <div class="value">8</div>
                            <div class="label">å·²å®Œæˆ</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">â¸ï¸</div>
                            <div class="value">6</div>
                            <div class="label">å·²æš‚åœ</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">ğŸ”¥ æœ€è¿‘é¡¹ç›®</h3>
                    <div id="recent-projects" class="work-summary" data-loading="true">
                        <div style="padding:20px; width:100%; text-align:center; color:#666;">åŠ è½½é¡¹ç›®ä¸­...</div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">ğŸ“‚ é¡¹ç›®åˆ†ç±»</h3>
                    <div class="menu">
                        <button class="menu-item" onclick="alert('å‰ç«¯é¡¹ç›®: 15ä¸ª')">
                            <span class="icon">ğŸŒ</span>
                            <div class="title">å‰ç«¯é¡¹ç›®</div>
                            <div class="desc">15 ä¸ªé¡¹ç›®</div>
                        </button>
                        <button class="menu-item" onclick="alert('åç«¯é¡¹ç›®: 8ä¸ª')">
                            <span class="icon">âš™ï¸</span>
                            <div class="title">åç«¯é¡¹ç›®</div>
                            <div class="desc">8 ä¸ªé¡¹ç›®</div>
                        </button>
                        <button class="menu-item" onclick="alert('ç§»åŠ¨ç«¯é¡¹ç›®: 3ä¸ª')">
                            <span class="icon">ğŸ“±</span>
                            <div class="title">ç§»åŠ¨ç«¯</div>
                            <div class="desc">3 ä¸ªé¡¹ç›®</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div id="statistics" class="content-section">
                <div class="section">
                    <h3 class="section-title">ğŸ“Š ä»Šæ—¥å·¥ä½œç»Ÿè®¡ <button class="refresh-btn" onclick="loadStats()">ğŸ”„ åˆ·æ–°</button>
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="icon">ğŸ“</div>
                            <div class="value" id="commits2">3</div>
                            <div class="label">ä»Šæ—¥æäº¤</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">â•</div>
                            <div class="value" id="insertions2">245</div>
                            <div class="label">æ–°å¢ä»£ç è¡Œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">â–</div>
                            <div class="value" id="deletions2">12</div>
                            <div class="label">åˆ é™¤ä»£ç è¡Œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">â°</div>
                            <div class="value" id="work-hours2">8</div>
                            <div class="label">å·¥ä½œæ—¶é•¿(å°æ—¶)</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ“</div>
                            <div class="value">26</div>
                            <div class="label">é¡¹ç›®æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ”¥</div>
                            <div class="value" id="productivity2">85%</div>
                            <div class="label">ç”Ÿäº§åŠ›</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">ğŸ“ˆ æœ¬å‘¨ä»£ç è¶‹åŠ¿</h3>
                    <div class="chart-container">
                        <div class="chart-bars" id="weeklyChart2">
                            <!-- é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨ä¸€</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨äºŒ</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨ä¸‰</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨å››</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨äº”</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨å…­</span></div>
                            <div class="chart-bar" style="height: 10%;"><span class="chart-bar-value">0</span><span
                                    class="chart-bar-label">å‘¨æ—¥</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å·¥ä½œè®°å½• -->
            <div id="timeline" class="content-section">
                <div class="section">
                    <h3 class="section-title">ğŸ’¼ ä»Šæ—¥å·¥ä½œè®°å½• <button class="refresh-btn" onclick="loadWorkTimeline()">ğŸ”„
                            åˆ·æ–°</button></h3>
                    <div id="workTimeline" class="work-summary">
                        <div class="work-item">
                            <div class="time">â³</div>
                            <div class="desc">æ­£åœ¨åŠ è½½å·¥ä½œè®°å½•...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿå·¥å…· -->
            <div id="tools" class="content-section">
                <div class="section">
                    <h3 class="section-title">ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
                    <div class="menu">
                        <button class="menu-item" onclick="openAction('ai')">
                            <span class="icon">ğŸš€</span>
                            <div class="title">æ–°å»ºé¡¹ç›®</div>
                            <div class="desc">åˆ›å»ºæ–°çš„å¼€å‘é¡¹ç›®</div>
                        </button>
                        <button class="menu-item" onclick="openAction('ls')">
                            <span class="icon">ğŸ“Š</span>
                            <div class="title">é¡¹ç›®åˆ—è¡¨</div>
                            <div class="desc">æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®</div>
                        </button>
                        <button class="menu-item" onclick="openAction('env')">
                            <span class="icon">ğŸ”§</span>
                            <div class="title">ç¯å¢ƒæ£€æŸ¥</div>
                            <div class="desc">æ£€æŸ¥å¼€å‘ç¯å¢ƒ</div>
                        </button>
                        <button class="menu-item" onclick="openAction('backup')">
                            <span class="icon">ğŸ’¾</span>
                            <div class="title">å¤‡ä»½é¡¹ç›®</div>
                            <div class="desc">å¤‡ä»½é‡è¦æ–‡ä»¶</div>
                        </button>
                        <button class="menu-item" onclick="openAction('vscode')">
                            <span class="icon">ğŸ’»</span>
                            <div class="title">VS Code</div>
                            <div class="desc">æ‰“å¼€ç¼–è¾‘å™¨</div>
                        </button>
                        <button class="menu-item" onclick="openAction('terminal')">
                            <span class="icon">âš¡</span>
                            <div class="title">æ‰“å¼€ç»ˆç«¯</div>
                            <div class="desc">è¿›å…¥å‘½ä»¤è¡Œ</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½® -->
            <div id="settings" class="content-section">
                <div class="section">
                    <h3 class="section-title">ğŸ”§ AI åŠ©ç†è®¾ç½®</h3>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="editUserName()" style="cursor: pointer;">
                            <div class="icon">ğŸ‘¤</div>
                            <div class="value" id="userName" style="font-size: 1.2em;">ç–¯ç‹‚çš„çŸ³å¤´</div>
                            <div class="label">ä¸ªæ€§åŒ–ç§°å‘¼</div>
                        </div>

                        <div class="stat-card" onclick="toggleAutoRefresh()" style="cursor: pointer;">
                            <div class="icon">ğŸ”„</div>
                            <div class="value">
                                <span id="autoRefreshStatus">å·²å¯ç”¨</span>
                                <div style="font-size: 0.6em; color: #999; margin-top: 5px;">
                                    é—´éš”: <span id="refreshInterval">30</span> åˆ†é’Ÿ
                                </div>
                            </div>
                            <div class="label">è‡ªåŠ¨åˆ·æ–°</div>
                        </div>

                        <div class="stat-card" onclick="editWorkTime()" style="cursor: pointer;">
                            <div class="icon">â°</div>
                            <div class="value" style="font-size: 0.9em;">
                                <span id="workStartTime">09:30</span> | <span id="workEndTime">18:30</span>
                                <div style="font-size: 0.7em; color: #999; margin-top: 5px;">åˆä¼‘: 12:30-14:00</div>
                            </div>
                            <div class="label">å·¥ä½œæ—¶é—´è®¾ç½®</div>
                        </div>

                        <div class="stat-card" onclick="editGitHubConfig()" style="cursor: pointer;">
                            <div class="icon">âš™ï¸</div>
                            <div class="value" style="font-size: 0.8em;">
                                <div id="githubUser">fengkuangdeshitou</div>
                                <div style="font-size: 0.8em; color: #999; margin-top: 5px;" id="githubRepo">
                                    ai-personal-assistant</div>
                            </div>
                            <div class="label">GitHub é…ç½®</div>
                        </div>

                        <div class="stat-card" onclick="editAIConfig()" style="cursor: pointer;">
                            <div class="icon">ğŸ¤–</div>
                            <div class="value" style="font-size: 0.9em;">
                                <div id="aiProviderDisplay">å†…ç½®è§„åˆ™</div>
                                <div style="font-size: 0.7em; color: #999; margin-top: 5px;" id="aiStatusDisplay">ä½¿ç”¨å†…ç½®å›å¤
                                </div>
                            </div>
                            <div class="label">AI å¯¹è¯é…ç½®</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">ğŸ“¦ ç³»ç»Ÿä¿¡æ¯ <button class="refresh-btn" onclick="loadSystemInfo()">ğŸ”„
                            åˆ·æ–°</button>
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="icon">ğŸ†š</div>
                            <div class="value" id="appVersion">v1.6.0</div>
                            <div class="label">å½“å‰ç‰ˆæœ¬</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ’»</div>
                            <div class="value" id="systemPlatform">-</div>
                            <div class="label">ç³»ç»Ÿå¹³å°</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸŒ</div>
                            <div class="value" id="browserInfo">-</div>
                            <div class="label">æµè§ˆå™¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ“…</div>
                            <div class="value" id="lastUpdateDate">-</div>
                            <div class="label">æœ€åæ›´æ–°</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ”—</div>
                            <div class="value" id="syncStatus">-</div>
                            <div class="label">åŒæ­¥çŠ¶æ€</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon">ğŸ’¾</div>
                            <div class="value" id="cacheSize">-</div>
                            <div class="label">ç¼“å­˜å¤§å°</div>
                        </div>
                    </div>
                </div>
            </div>

            
        </div>

    </div>
    </div>


    <script>
        // é¡µé¢å¯¼èˆªåˆ‡æ¢
        function showSection(sectionId, element) {
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            // æ˜¾ç¤ºç›®æ ‡å†…å®¹åŒºåŸŸ
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªé¡¹
            if (element) {
                element.classList.add('active');
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°æ•°æ®ç»Ÿè®¡é¡µé¢ï¼Œè‡ªåŠ¨åŠ è½½æ•°æ®
            if (sectionId === 'statistics') {
                loadStats();
                updateWeeklyChart('weeklyChart2');
            }
        }

        function updateGreeting() {
            const settings = getSettings();
            const hour = new Date().getHours();
            let greeting = hour < 6 ? 'ğŸŒ™ æ·±å¤œäº†' : hour < 9 ? 'ğŸŒ… æ—©å®‰' : hour < 12 ? 'â˜€ï¸ ä¸Šåˆå¥½' : hour < 14 ? 'ğŸŒ¤ï¸ ä¸­åˆå¥½' : hour < 18 ? 'ğŸŒ† ä¸‹åˆå¥½' : hour < 22 ? 'ğŸŒƒ æ™šä¸Šå¥½' : 'ğŸŒ™ å¤œæ·±äº†';
            document.getElementById('greeting').textContent = greeting + 'ï¼Œ' + settings.userName + 'ï¼';
            const now = new Date();
            document.getElementById('time').textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }) + ' ' + now.toLocaleTimeString('zh-CN');

            // æ›´æ–°å·¥ä½œæ—¶é•¿
            updateWorkHours();
        }

        async function loadStats() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                ['commits', 'insertions', 'deletions', 'commits2', 'insertions2', 'deletions2'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.opacity = '0.5';
                        el.textContent = '...';
                    }
                });

                // è·å–çœŸå®çš„ Git ç»Ÿè®¡æ•°æ®
                const stats = await fetchGitStats();

                // æ›´æ–°é¡µé¢æ•°æ®
                ['commits', 'commits2'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = stats.commits;
                        el.style.opacity = '1';
                    }
                });

                ['insertions', 'insertions2'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = stats.insertions;
                        el.style.opacity = '1';
                    }
                });

                ['deletions', 'deletions2'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = stats.deletions;
                        el.style.opacity = '1';
                    }
                });

                // æ›´æ–°å·¥ä½œæ—¶é•¿
                updateWorkHours();

                // æ›´æ–°ç”Ÿäº§åŠ›æŒ‡æ ‡
                updateProductivity(stats);

                showNotification('âœ… ç»Ÿè®¡æ•°æ®å·²æ›´æ–° - ' + new Date().toLocaleTimeString());
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                showNotification('âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // è·å–çœŸå®çš„ Git ç»Ÿè®¡æ•°æ®
        async function fetchGitStats() {
            // ä¼˜å…ˆä»åç«¯APIè·å–æœ¬åœ°Gitä»“åº“çš„ç»Ÿè®¡æ•°æ®
            try {
                const response = await fetch('http://localhost:5178/api/projects');
                if (response.ok) {
                    const data = await response.json();
                    if (data.projects && data.projects.length > 0) {
                        // ç»Ÿè®¡æ‰€æœ‰é¡¹ç›®ä»Šå¤©çš„å˜æ›´
                        let totalModified = 0;
                        let totalAdded = 0;
                        let totalDeleted = 0;
                        let todayCommits = 0;
                        
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        // éå†æ‰€æœ‰é¡¹ç›®
                        for (const project of data.projects) {
                            // æ£€æŸ¥æœ€åæäº¤æ˜¯å¦æ˜¯ä»Šå¤©
                            if (project.lastCommitTime) {
                                const commitDate = new Date(project.lastCommitTime);
                                commitDate.setHours(0, 0, 0, 0);
                                
                                if (commitDate.getTime() === today.getTime()) {
                                    todayCommits++;
                                }
                            }
                            
                            // è·å–é¡¹ç›®çŠ¶æ€
                            try {
                                const statusRes = await fetch(`http://localhost:5178/api/status?path=${encodeURIComponent(project.path)}`);
                                if (statusRes.ok) {
                                    const status = await statusRes.json();
                                    totalModified += status.modified || 0;
                                    totalAdded += status.added || 0;
                                    totalDeleted += status.deleted || 0;
                                }
                            } catch (e) {
                                console.warn(`è·å–é¡¹ç›® ${project.name} çŠ¶æ€å¤±è´¥:`, e);
                            }
                        }
                        
                        const stats = {
                            commits: todayCommits,
                            insertions: totalAdded,
                            deletions: totalDeleted,
                            modified: totalModified
                        };
                        
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        saveLocalStats(stats);
                        
                        return stats;
                    }
                }
            } catch (error) {
                console.warn('åç«¯APIè·å–å¤±è´¥ï¼Œå°è¯•GitHub API:', error);
                // è‡ªåŠ¨å°è¯•å¯åŠ¨åç«¯æœåŠ¡
                tryStartBackend();
            }

            // å¦‚æœåç«¯å¤±è´¥ï¼Œå°è¯•GitHub API
            const settings = getSettings();
            const owner = settings.githubUser;
            const repo = settings.githubRepo;
            const token = settings.githubToken;
            const today = new Date().toISOString().split('T')[0];

            try {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };

                // å¦‚æœæœ‰ tokenï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                // è·å–ä»Šæ—¥æäº¤è®°å½•
                const response = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/commits?since=${today}T00:00:00Z`,
                    { headers }
                );

                if (!response.ok) {
                    throw new Error('GitHub API è¯·æ±‚å¤±è´¥');
                }

                const commits = await response.json();
                let insertions = 0;
                let deletions = 0;

                // è·å–æ¯ä¸ªæäº¤çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«ä»£ç è¡Œæ•°å˜æ›´ï¼‰
                for (const commit of commits.slice(0, 10)) { // é™åˆ¶æœ€å¤š10ä¸ªæäº¤
                    try {
                        const detailResponse = await fetch(commit.url, { headers });
                        const detail = await detailResponse.json();
                        if (detail.stats) {
                            insertions += detail.stats.additions || 0;
                            deletions += detail.stats.deletions || 0;
                        }
                    } catch (e) {
                        console.warn('è·å–æäº¤è¯¦æƒ…å¤±è´¥:', e);
                    }
                }

                const stats = {
                    commits: commits.length,
                    insertions: insertions,
                    deletions: deletions
                };
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveLocalStats(stats);
                
                return stats;
            } catch (error) {
                console.error('GitHub API é”™è¯¯:', error);
                // å¦‚æœéƒ½å¤±è´¥ï¼Œè¿”å›æœ¬åœ°å­˜å‚¨çš„æ•°æ®æˆ–é»˜è®¤å€¼
                return getLocalStats();
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨è·å–ç»Ÿè®¡æ•°æ®ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function getLocalStats() {
            const stored = localStorage.getItem('gitStats');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('è§£ææœ¬åœ°æ•°æ®å¤±è´¥:', e);
                }
            }
            // é»˜è®¤å€¼
            return {
                commits: 0,
                insertions: 0,
                deletions: 0
            };
        }

        // ä¿å­˜ç»Ÿè®¡æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveLocalStats(stats) {
            localStorage.setItem('gitStats', JSON.stringify(stats));
            localStorage.setItem('gitStatsTime', new Date().toISOString());
        }

        // è·å–æœ¬å‘¨æ¯å¤©çš„æäº¤æ•°æ®
        async function fetchWeeklyStats() {
            // ä¼˜å…ˆä»åç«¯APIè·å–çœŸå®Gitæäº¤å†å²
            try {
                const response = await fetch('http://localhost:5178/api/commits/weekly');
                if (response.ok) {
                    const data = await response.json();
                    if (data.dailyStats) {
                        const weeklyData = [0, 0, 0, 0, 0, 0, 0]; // å‘¨ä¸€åˆ°å‘¨æ—¥
                        
                        // è·å–æœ¬å‘¨çš„æ—¥æœŸèŒƒå›´
                        const now = new Date();
                        const dayOfWeek = now.getDay();
                        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        
                        // å¡«å……æœ¬å‘¨æ¯å¤©çš„çœŸå®æ•°æ®
                        for (let i = 0; i < 7; i++) {
                            const date = new Date(now);
                            date.setDate(now.getDate() + mondayOffset + i);
                            const dayKey = date.toISOString().split('T')[0];
                            
                            if (data.dailyStats[dayKey]) {
                                // ä½¿ç”¨çœŸå®çš„ä»£ç è¡Œæ•°å˜åŒ–ï¼ˆæ’å…¥+åˆ é™¤ï¼‰
                                weeklyData[i] = data.dailyStats[dayKey].lines;
                            }
                        }
                        
                        // ä¿å­˜åˆ°localStorage
                        localStorage.setItem('weeklyStats', JSON.stringify(weeklyData));
                        localStorage.setItem('weeklyCommits', JSON.stringify(data.commits));
                        localStorage.setItem('weeklyStatsTime', Date.now().toString());
                        
                        console.log('âœ… æœ¬å‘¨ä»£ç ç»Ÿè®¡ï¼ˆçœŸå®æ•°æ®ï¼‰:', weeklyData);
                        return weeklyData;
                    }
                }
            } catch (error) {
                console.warn('åç«¯APIè·å–æœ¬å‘¨æ•°æ®å¤±è´¥ï¼Œå°è¯•GitHub API:', error);
            }

            // å¦‚æœåç«¯å¤±è´¥ï¼Œå°è¯•GitHub API
            const settings = getSettings();
            const owner = settings.githubUser;
            const repo = settings.githubRepo;
            const token = settings.githubToken;

            try {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };

                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                // è·å–æœ¬å‘¨çš„å¼€å§‹æ—¥æœŸï¼ˆå‘¨ä¸€ï¼‰
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0 = å‘¨æ—¥, 1 = å‘¨ä¸€, ...
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // å¦‚æœæ˜¯å‘¨æ—¥ï¼Œå¾€å›6å¤©ï¼›å¦åˆ™åˆ°å‘¨ä¸€
                const monday = new Date(now);
                monday.setDate(now.getDate() + mondayOffset);
                monday.setHours(0, 0, 0, 0);

                // è·å–æœ¬å‘¨çš„æ‰€æœ‰æäº¤
                const response = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/commits?since=${monday.toISOString()}`,
                    { headers }
                );

                if (!response.ok) {
                    throw new Error('GitHub API è¯·æ±‚å¤±è´¥');
                }

                const commits = await response.json();

                // æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡ä»£ç è¡Œæ•°
                const weeklyData = [0, 0, 0, 0, 0, 0, 0]; // å‘¨ä¸€åˆ°å‘¨æ—¥

                for (const commit of commits) {
                    const commitDate = new Date(commit.commit.author.date);
                    const dayIndex = commitDate.getDay();
                    const adjustedIndex = dayIndex === 0 ? 6 : dayIndex - 1; // è½¬æ¢ä¸ºå‘¨ä¸€=0çš„ç´¢å¼•

                    // è·å–æäº¤è¯¦æƒ…ä»¥å¾—åˆ°ä»£ç è¡Œæ•°
                    try {
                        const detailResponse = await fetch(commit.url, { headers });
                        const detail = await detailResponse.json();
                        if (detail.stats) {
                            weeklyData[adjustedIndex] += detail.stats.additions || 0;
                        }
                    } catch (e) {
                        console.warn('è·å–æäº¤è¯¦æƒ…å¤±è´¥:', e);
                        // å¦‚æœæ— æ³•è·å–è¯¦æƒ…ï¼Œå°±ç»Ÿè®¡æäº¤æ¬¡æ•° * 50ï¼ˆä¼°ç®—ï¼‰
                        weeklyData[adjustedIndex] += 50;
                    }
                }

                localStorage.setItem('weeklyStats', JSON.stringify(weeklyData));
                return weeklyData;
            } catch (error) {
                console.error('è·å–æœ¬å‘¨æ•°æ®å¤±è´¥:', error);
                // è¿”å›æœ¬åœ°ç¼“å­˜æˆ–é»˜è®¤å€¼
                const cached = localStorage.getItem('weeklyStats');
                if (cached) {
                    try {
                        return JSON.parse(cached);
                    } catch (e) {
                        console.error('è§£æç¼“å­˜æ•°æ®å¤±è´¥:', e);
                    }
                }
                return [0, 0, 0, 0, 0, 0, 0];
            }
        }

        // æ›´æ–°æœ¬å‘¨è¶‹åŠ¿å›¾è¡¨
        async function updateWeeklyChart(chartId = 'weeklyChart') {
            try {
                const weeklyData = await fetchWeeklyStats();

                // ä¿å­˜åˆ°ç¼“å­˜
                localStorage.setItem('weeklyStats', JSON.stringify(weeklyData));

                // æ‰¾åˆ°æœ€å¤§å€¼ç”¨äºè®¡ç®—ç™¾åˆ†æ¯”
                const maxValue = Math.max(...weeklyData, 1); // è‡³å°‘ä¸º1ï¼Œé¿å…é™¤ä»¥0

                // æ›´æ–°å›¾è¡¨
                const chartBars = document.getElementById(chartId);
                if (chartBars) {
                    const dayLabels = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
                    const now = new Date();
                    const today = now.getDay();
                    const todayIndex = today === 0 ? 6 : today - 1; // è½¬æ¢ä¸ºå‘¨ä¸€=0çš„ç´¢å¼•

                    chartBars.innerHTML = weeklyData.map((value, index) => {
                        const height = Math.max(10, (value / maxValue) * 95); // æœ€å°é«˜åº¦10%
                        const isToday = index === todayIndex;
                        const label = isToday ? 'ä»Šå¤©' : dayLabels[index];
                        const barClass = isToday ? 'chart-bar' : 'chart-bar';

                        return `
                            <div class="${barClass}" style="height: ${height}%;">
                                <span class="chart-bar-value">${value}</span>
                                <span class="chart-bar-label">${label}</span>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('æ›´æ–°æœ¬å‘¨å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å·¥ä½œæ—¶é•¿
        function updateWorkHours() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            let workHours = 0;

            // å·¥ä½œæ—¶é—´: 9:30-12:30 (3h) + 14:00-18:30 (4.5h)
            if (currentHour > 9 || (currentHour === 9 && currentMinute >= 30)) {
                if (currentHour < 12 || (currentHour === 12 && currentMinute <= 30)) {
                    // ä¸Šåˆå·¥ä½œæ—¶é—´
                    const morningMinutes = (currentHour - 9) * 60 + currentMinute - 30;
                    workHours = Math.max(0, morningMinutes / 60);
                } else if (currentHour >= 12 && currentHour < 14) {
                    // åˆä¼‘æ—¶é—´ 12:30-14:00ï¼Œæ˜¾ç¤ºä¸Šåˆçš„3å°æ—¶
                    workHours = 3;
                } else if (currentHour >= 14) {
                    workHours = 3; // ä¸Šåˆ3å°æ—¶
                    if (currentHour < 18 || (currentHour === 18 && currentMinute <= 30)) {
                        // ä¸‹åˆå·¥ä½œæ—¶é—´
                        const afternoonMinutes = (currentHour - 14) * 60 + currentMinute;
                        workHours += afternoonMinutes / 60;
                    } else {
                        workHours += 4.5; // ä¸‹åˆ4.5å°æ—¶
                    }
                }
            }

            ['work-hours', 'work-hours2'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = workHours.toFixed(1);
                    el.style.opacity = '1';
                }
            });
        }

        // æ›´æ–°ç”Ÿäº§åŠ›æŒ‡æ ‡
        function updateProductivity(stats) {
            // åŸºäºä»£ç é‡å’Œæäº¤æ¬¡æ•°è®¡ç®—ç”Ÿäº§åŠ›
            const totalLines = stats.insertions + stats.deletions;
            const productivity = Math.min(100, Math.round(
                (stats.commits * 10) + (totalLines / 10)
            ));

            ['productivity', 'productivity2'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = productivity + '%';
                }
            });
        }

        function showNotification(msg) {
            const n = document.createElement('div');
            n.textContent = msg;
            n.style.cssText = 'position:fixed;top:20px;right:20px;background:#667eea;color:white;padding:15px 25px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.3);z-index:1000;animation:slideIn 0.3s';
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 2000);
        }

        // è‡ªåŠ¨å°è¯•å¯åŠ¨åç«¯æœåŠ¡
        let backendStartAttempted = false;
        async function tryStartBackend() {
            if (backendStartAttempted) return;
            backendStartAttempted = true;
            
            console.log('æ£€æµ‹åˆ°åç«¯æœªå¯åŠ¨ï¼Œå°è¯•è‡ªåŠ¨å¯åŠ¨...');
            
            try {
                // å°è¯•é€šè¿‡ file:// åè®®æ‰§è¡Œè„šæœ¬ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼Œè¿™é€šå¸¸ä¸ä¼šæˆåŠŸï¼‰
                // ä½†æˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªä¸€æ¬¡æ€§æç¤ºè®©ç”¨æˆ·çŸ¥é“éœ€è¦å¯åŠ¨
                const response = await fetch('http://localhost:5178/api/projects');
                if (response.ok) {
                    console.log('åç«¯æœåŠ¡å·²å¯åŠ¨');
                    backendStartAttempted = false; // é‡ç½®ï¼Œå…è®¸å†æ¬¡æ£€æŸ¥
                }
            } catch (e) {
                // é™é»˜å¤±è´¥ï¼Œä½¿ç”¨ GitHub API ä½œä¸ºå¤‡é€‰
                console.log('ä½¿ç”¨ GitHub API ä½œä¸ºæ•°æ®æº');
            }
        }

        // ==================== é¡¹ç›®æ“ä½œå‡½æ•° ====================

        // ä»åç«¯è·å–çš„é¡¹ç›®è·¯å¾„æ˜ å°„
        window.PROJECT_PATHS = {};

        function getProjectPath(projectName) {
            return window.PROJECT_PATHS[projectName] || `~/Projects/${projectName}`;
        }

        // Git Pull - æ‹‰å–æœ€æ–°ä»£ç 
        function gitPull(projectName) {
            const path = getProjectPath(projectName);
            const command = `cd ${path} && git pull`;
            const message = `ğŸ“¥ æ‹‰å– ${projectName} æœ€æ–°ä»£ç \n\nå‘½ä»¤ï¼š${command}`;
            
            showCommandModal('Git Pull', message, command);
            showNotification(`ğŸ”„ æ­£åœ¨æ‹‰å– ${projectName}...`);
        }

        // Git Push - æ¨é€ä»£ç 
        function gitPush(projectName) {
            const path = getProjectPath(projectName);
            const commands = [
                `cd ${path}`,
                `git add .`,
                `git commit -m "Update: $(date +%Y-%m-%d)"`,
                `git push`
            ].join(' && ');
            
            const message = `ğŸ“¤ æ¨é€ ${projectName} ä»£ç \n\nå‘½ä»¤ï¼š\n${commands}`;
            
            showCommandModal('Git Push', message, commands);
            showNotification(`â¬†ï¸ æ­£åœ¨æ¨é€ ${projectName}...`);
        }

        // åœ¨ VS Code ä¸­æ‰“å¼€
        function openInVSCode(projectName) {
            const path = getProjectPath(projectName);
            const command = `code ${path}`;
            const message = `ğŸ’» åœ¨ VS Code ä¸­æ‰“å¼€ ${projectName}\n\nå‘½ä»¤ï¼š${command}`;
            
            showCommandModal('Open in VS Code', message, command);
            showNotification(`ğŸ’» æ‰“å¼€ ${projectName}...`);
        }

        // åœ¨ Finder ä¸­æ‰“å¼€
        function openInFinder(projectName) {
            const path = getProjectPath(projectName);
            const command = `open ${path}`;
            const message = `ğŸ“ åœ¨ Finder ä¸­æ‰“å¼€ ${projectName}\n\nå‘½ä»¤ï¼š${command}`;
            
            showCommandModal('Open in Finder', message, command);
            showNotification(`ğŸ“ æ‰“å¼€ ${projectName} ç›®å½•...`);
        }

        // æ„å»ºé¡¹ç›®
        async function buildProject(projectName) {
            return new Promise((resolve, reject) => {
                const path = getProjectPath(projectName);
                
                // æ˜¾ç¤ºæ„å»ºè¿›åº¦å¼¹æ¡†
                const modalContent = `
                    <div style="padding: 30px;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”¨</div>
                            <h3 style="margin: 0 0 15px 0; color: #333;">æ­£åœ¨æ„å»º ${projectName}</h3>
                            <div id="build-progress-text" style="color: #666; margin-bottom: 20px;">å‡†å¤‡æ„å»ºç¯å¢ƒ...</div>
                            <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-bottom: 20px;">
                                <div id="build-progress-bar" style="width: 10%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div id="build-log-container" style="margin-top: 20px; max-height: 350px; overflow-y: auto; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.8em;">
                            <div id="build-log"></div>
                        </div>
                    </div>
                    <style>
                        #build-log-container::-webkit-scrollbar { width: 8px; }
                        #build-log-container::-webkit-scrollbar-track { background: #2d2d2d; }
                        #build-log-container::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
                    </style>
                `;
                
                showCustomModal(modalContent);
                
                const progressBar = document.getElementById('build-progress-bar');
                const progressText = document.getElementById('build-progress-text');
                const logContainer = document.getElementById('build-log-container');
                const logElement = document.getElementById('build-log');
                
                let progress = 10;
                let logLines = [];
                let buildSuccess = false;
                
                (async () => {
                    try {
                        // ä½¿ç”¨ fetch å‘é€æ„å»ºè¯·æ±‚å¹¶è¯»å–æµå¼å“åº”
                        const response = await fetch('http://localhost:5178/api/build-stream', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ projectName, channel: null })
                        });
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        progressBar.style.width = '20%';
                        progressText.textContent = 'æ­£åœ¨æ‰§è¡Œ npm run build...';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            
                            if (done) break;
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        
                                        // æ›´æ–°è¿›åº¦
                                        if (progress < 90) {
                                            progress += 2;
                                            progressBar.style.width = progress + '%';
                                        }
                                        
                                        // æ·»åŠ æ—¥å¿—
                                        if (data.type === 'log' || data.type === 'stdout') {
                                            const logLine = document.createElement('div');
                                            logLine.style.marginBottom = '4px';
                                            logLine.style.color = '#00ff00';
                                            logLine.textContent = '> ' + data.message;
                                            logElement.appendChild(logLine);
                                            logLines.push(data.message);
                                        } else if (data.type === 'stderr') {
                                            const logLine = document.createElement('div');
                                            logLine.style.marginBottom = '4px';
                                            logLine.style.color = '#ffaa00';
                                            logLine.textContent = 'âš  ' + data.message;
                                            logElement.appendChild(logLine);
                                        } else if (data.type === 'success') {
                                            buildSuccess = true;
                                            progressBar.style.width = '100%';
                                            progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
                                            progressText.textContent = 'âœ… æ„å»ºæˆåŠŸï¼';
                                            progressText.style.color = '#10b981';
                                            
                                            const successLine = document.createElement('div');
                                            successLine.style.marginTop = '10px';
                                            successLine.style.color = '#00ff00';
                                            successLine.style.fontWeight = 'bold';
                                            successLine.textContent = 'âœ… ' + data.message;
                                            logElement.appendChild(successLine);
                                            
                                            showNotification(`âœ… æ„å»ºæˆåŠŸ: ${projectName} - ç°åœ¨å¯ä»¥ç‚¹å‡» â˜ï¸ ä¸Šä¼ æŒ‰é’®`);
                                            // æ„å»ºæˆåŠŸåæ˜¾ç¤ºä¸Šä¼ é€‰é¡¹
                                            setTimeout(() => {
                                                closeModal();
                                                showUploadOptions(projectName);
                                                resolve(true);
                                            }, 2000);
                                        } else if (data.type === 'error') {
                                            progressBar.style.width = '100%';
                                            progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                                            progressText.textContent = 'âŒ æ„å»ºå¤±è´¥';
                                            progressText.style.color = '#ef4444';
                                            
                                            const errorLine = document.createElement('div');
                                            errorLine.style.marginTop = '10px';
                                            errorLine.style.color = '#ff4444';
                                            errorLine.style.fontWeight = 'bold';
                                            errorLine.textContent = 'âŒ ' + data.message;
                                            logElement.appendChild(errorLine);
                                            
                                            showNotification(`âŒ æ„å»ºå¤±è´¥: ${data.message}`);
                                            
                                            // 10ç§’åå…³é—­å¹¶ reject
                                            setTimeout(() => {
                                                closeModal();
                                                reject(new Error(data.message));
                                            }, 10000);
                                        }
                                        
                                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                        logContainer.scrollTop = logContainer.scrollHeight;
                                        
                                    } catch (e) {
                                        console.error('Failed to parse SSE data:', e);
                                    }
                                }
                            }
                        }
                        
                    } catch (err) {
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                        progressText.textContent = 'âŒ æ„å»ºå¤±è´¥';
                        progressText.style.color = '#ef4444';
                        
                        const errorLine = document.createElement('div');
                        errorLine.style.color = '#ff4444';
                        errorLine.style.fontWeight = 'bold';
                        errorLine.textContent = 'âŒ ' + err.message;
                        logElement.appendChild(errorLine);
                        
                        showNotification(`âŒ æ„å»ºå¤±è´¥: ${err.message}`);
                        
                        setTimeout(() => {
                            closeModal();
                            reject(err);
                        }, 10000);
                    }
                })();
            });
        }
        
        // HTML è½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºæ„å»ºé€‰é¡¹ï¼ˆå¦‚æœæœ‰æ¸ é“é…ç½®åˆ™æ˜¾ç¤ºæ¸ é“é€‰æ‹©ï¼‰
        async function showBuildOptions(projectName) {
            try {
                const response = await fetch(`http://localhost:5178/api/channels/${projectName}`);
                const data = await response.json();
                
                if (data.channels && Object.keys(data.channels).length > 0) {
                    // æœ‰æ¸ é“é…ç½®ï¼Œæ˜¾ç¤ºæ¸ é“é€‰æ‹©å¼¹çª—
                    showChannelSelectionModal(projectName, data.channels);
                } else {
                    // æ²¡æœ‰æ¸ é“é…ç½®ï¼Œç›´æ¥æ„å»º
                    buildProject(projectName);
                }
            } catch (err) {
                console.error('Failed to load channels:', err);
                // å‡ºé”™æ—¶ç›´æ¥æ„å»º
                buildProject(projectName);
            }
        }

        // æ˜¾ç¤ºæ¸ é“é€‰æ‹©å¼¹çª—ï¼ˆä»…ç”¨äºæ„å»ºï¼Œç®€åŒ–ç‰ˆï¼‰
        function showChannelSelectionModal(projectName, channels) {
            // åªæ˜¾ç¤ºæŒ‡å®šçš„4ä¸ªæ¸ é“
            const targetChannels = ['hg', '05', '01', 'hz'];
            const filteredChannels = Object.fromEntries(
                Object.entries(channels).filter(([id]) => targetChannels.includes(id))
            );

            const channelOptions = Object.entries(filteredChannels).map(([id, config]) => `
                <div class="channel-item" onclick="selectChannelAndBuild('${projectName}', '${id}');" style="cursor: pointer; padding: 12px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                     onmouseover="this.style.background='#f8f9ff'"
                     onmouseout="this.style.background='white'">
                    <div style="font-weight: 500; color: #333;">${config.name}</div>
                    <div style="font-size: 0.85em; color: #999; margin-top: 2px;">${id}</div>
                </div>
            `).join('');

            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #333;">ğŸ”¨ é€‰æ‹©æ„å»ºæ¸ é“</h3>
                    <div style="border-radius: 12px; overflow: hidden; border: 1px solid #e0e0e0;">
                        ${channelOptions}
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="closeModal();" 
                                style="padding: 10px 20px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                            å–æ¶ˆ
                        </button>
                        <button onclick="selectChannelAndBuild('${projectName}', null);" 
                                style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ç›´æ¥æ„å»º
                        </button>
                    </div>
                </div>
            `;

            showCustomModal(modalContent);
        }
        
        // é€‰æ‹©æ¸ é“åæ„å»ºï¼ˆå…ˆå…³é—­å¼¹çª—å†æ˜¾ç¤ºæ„å»ºè¿›åº¦ï¼‰
        function selectChannelAndBuild(projectName, channel) {
            closeModal();
            // ç­‰å¾…å¼¹çª—å…³é—­åŠ¨ç”»å®Œæˆåå†æ˜¾ç¤ºæ„å»ºè¿›åº¦
            setTimeout(() => {
                if (channel) {
                    buildWithChannel(projectName, channel, false);
                } else {
                    buildProject(projectName);
                }
            }, 200);
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
        function showCustomModal(content) {
            // å…ˆå…³é—­å·²å­˜åœ¨çš„å¼¹çª—
            const existingModal = document.getElementById('customModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    ${content}
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            // å…³é—­æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å¼¹çª—
            const modals = document.querySelectorAll('#customModal');
            modals.forEach(modal => modal.remove());
        }

        // æ„å»ºæˆåŠŸåæ˜¾ç¤ºæ¸ é“é€‰æ‹©å¼¹æ¡†
        async function showUploadForChannel(projectName, currentChannel) {
            try {
                const response = await fetch(`http://localhost:5178/api/channels/${projectName}`);
                const data = await response.json();

                // åªæ˜¾ç¤ºæŒ‡å®šçš„4ä¸ªæ¸ é“
                const targetChannels = ['hg', '05', '01', 'hz'];
                const filteredChannels = Object.fromEntries(
                    Object.entries(data.channels).filter(([id]) => targetChannels.includes(id))
                );

                const channelCards = Object.entries(filteredChannels).map(([id, config]) => {
                    const isCurrentChannel = currentChannel && id === currentChannel;
                    const cardStyle = isCurrentChannel
                        ? 'border: 3px solid #667eea; background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);'
                        : 'border: 2px solid #e8f0fe; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); box-shadow: 0 4px 15px rgba(0,0,0,0.08);';

                    // æ ¹æ®æ¸ é“IDè®¾ç½®ä¸åŒçš„é¢œè‰²ä¸»é¢˜
                    const channelThemes = {
                        'hg': { icon: 'ğŸ®', color: '#667eea', bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                        '05': { icon: 'ğŸ’°', color: '#10b981', bg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)' },
                        '01': { icon: 'ğŸ¯', color: '#f59e0b', bg: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' },
                        'hz': { icon: 'ğŸ¾', color: '#ec4899', bg: 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)' }
                    };

                    const theme = channelThemes[id] || { icon: 'ğŸ“¦', color: '#6b7280', bg: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)' };

                    return `
                        <div class="channel-card" onclick="closeModal(); setTimeout(() => buildWithChannel('${projectName}', '${id}', true), 100);"
                             style="width: 180px; padding: 24px 16px; ${cardStyle} border-radius: 16px; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); text-align: center; position: relative; overflow: hidden; flex-shrink: 0;"
                             onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='${isCurrentChannel ? '0 12px 35px rgba(102, 126, 234, 0.3)' : '0 12px 35px rgba(0,0,0,0.15)'}';"
                             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='${isCurrentChannel ? '0 8px 25px rgba(102, 126, 234, 0.2)' : '0 4px 15px rgba(0,0,0,0.08)'}';">
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${theme.bg};"></div>
                            <div style="font-size: 2.5em; margin-bottom: 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">${isCurrentChannel ? 'âœ…' : theme.icon}</div>
                            <div style="font-weight: 700; color: #1f2937; margin-bottom: 6px; font-size: 1.1em; letter-spacing: 0.5px;">${config.name}</div>
                            <div style="font-size: 0.85em; color: #6b7280; background: rgba(107, 114, 128, 0.1); padding: 4px 8px; border-radius: 12px; display: inline-block; font-weight: 500;">${id.toUpperCase()}</div>
                            ${isCurrentChannel ? '<div style="position: absolute; top: 12px; right: 12px; background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600;">å½“å‰</div>' : ''}
                        </div>
                    `;
                }).join('');

                const modalContent = `
                    <div style="padding: 30px; max-width: 1000px; margin: 0 auto; min-width: 900px;">
                        <h3 style="margin: 0 0 30px 0; color: #333; text-align: center;">ğŸ¯ é€‰æ‹©æ„å»ºæ¸ é“</h3>
                        <div style="display: flex; gap: 20px; margin-bottom: 30px; justify-content: center;">
                            ${channelCards}
                        </div>
                        <div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 30px;">
                            ç‚¹å‡»æ¸ é“å¡ç‰‡å¼€å§‹Build
                        </div>
                        <div style="text-align: right;">
                            <button onclick="closeModal();"
                                    style="padding: 12px 24px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em;">
                                ç¨åä¸Šä¼ 
                            </button>
                        </div>
                    </div>
                `;

                // åˆ›å»ºæ›´å¤§çš„å¼¹æ¡†
                const modal = document.createElement('div');
                modal.id = 'customModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 1100px; width: 95%; min-height: 400px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        ${modalContent}
                    </div>
                `;
                
                // å…ˆå…³é—­å·²å­˜åœ¨çš„å¼¹çª—
                const existingModal = document.getElementById('customModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.appendChild(modal);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            } catch (err) {
                console.error('Failed to load channel config:', err);
                showNotification(`âŒ åŠ è½½é…ç½®å¤±è´¥: ${err.message}`);
            }
        }

        // æ˜¾ç¤ºæŒ‡å®šæ¸ é“çš„ç¯å¢ƒé€‰æ‹©
        async function showChannelEnvSelection(projectName, channel) {
            try {
                const response = await fetch(`http://localhost:5178/api/channels/${projectName}`);
                const data = await response.json();
                
                if (data.channels && data.channels[channel]) {
                    const channelConfig = data.channels[channel];
                    const hasBuckets = channelConfig.buckets && typeof channelConfig.buckets === 'object';
                    
                    if (!hasBuckets) {
                        showNotification(`âŒ æ¸ é“ ${channel} æœªé…ç½® OSS bucket`);
                        return;
                    }
                    
                    const devBucket = channelConfig.buckets.dev ? (channelConfig.buckets.dev.name || channelConfig.buckets.dev) : 'æœªé…ç½®';
                    const prodBucket = channelConfig.buckets.prod ? (channelConfig.buckets.prod.name || channelConfig.buckets.prod) : 'æœªé…ç½®';
                    
                    const modalContent = `
                        <div style="padding: 20px;">
                            <h3 style="margin: 0 0 20px 0; color: #333;">â˜ï¸ é€‰æ‹©ä¸Šä¼ ç¯å¢ƒ</h3>
                            <div style="padding: 20px; border: 1px solid #e0e0e0; border-radius: 12px;">
                                <div style="font-weight: 500; color: #333; margin-bottom: 16px; font-size: 1.05em;">${projectName} - ${channelConfig.name}</div>
                                <div style="display: flex; gap: 16px; flex-direction: row;">
                                    <button onclick="doUploadWithChannel('${projectName}', '${channel}', 'dev');"
                                            style="flex: 1; padding: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: 500; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)';">
                                        ğŸ“¦ å¼€å‘ç¯å¢ƒ<br><span style="font-size: 0.85em; opacity: 0.9;">${devBucket}</span>
                                    </button>
                                    <button onclick="doUploadWithChannel('${projectName}', '${channel}', 'prod');"
                                            style="flex: 1; padding: 24px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: 500; transition: all 0.3s; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(245, 87, 108, 0.4)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(245, 87, 108, 0.3)';">
                                        ğŸš€ ç”Ÿäº§ç¯å¢ƒ<br><span style="font-size: 0.85em; opacity: 0.9;">${prodBucket}</span>
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: right;">
                                <button onclick="closeModal();" 
                                        style="padding: 10px 20px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                                    ç¨åä¸Šä¼ 
                                </button>
                            </div>
                        </div>
                    `;

                    showCustomModal(modalContent);
                } else {
                    showNotification(`âŒ æœªæ‰¾åˆ°æ¸ é“ ${channel} çš„é…ç½®`);
                }
            } catch (err) {
                console.error('Failed to load channel config:', err);
                showNotification(`âŒ åŠ è½½é…ç½®å¤±è´¥: ${err.message}`);
            }
        }        // æ˜¾ç¤ºä¸Šä¼ é€‰é¡¹ï¼ˆæ¸ é“å’Œç¯å¢ƒé€‰æ‹©ï¼‰
        async function showUploadOptions(projectName) {
            try {
                const response = await fetch(`http://localhost:5178/api/channels/${projectName}`);
                const data = await response.json();

                if (data.channels && Object.keys(data.channels).length > 0) {
                    // æœ‰æ¸ é“é…ç½®ï¼Œç›´æ¥æ˜¾ç¤º4ä¸ªæ¸ é“å¡ç‰‡é€‰æ‹©
                    showUploadForChannel(projectName, null);
                } else {
                    // æ²¡æœ‰æ¸ é“é…ç½®ï¼Œä½¿ç”¨é»˜è®¤ä¸Šä¼ 
                    uploadWithoutChannel(projectName);
                }
            } catch (err) {
                console.error('Failed to load channels:', err);
                // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤ä¸Šä¼ 
                uploadWithoutChannel(projectName);
            }
        }

        // æ— æ¸ é“é¡¹ç›®çš„é»˜è®¤ä¸Šä¼ ï¼ˆæ˜¾ç¤ºç¯å¢ƒé€‰æ‹©ï¼‰
        async function uploadWithoutChannel(projectName) {
            try {
                // è·å–é¡¹ç›®çš„ bucket é…ç½®
                const response = await fetch(`http://localhost:5178/api/project-buckets/${projectName}`);
                const data = await response.json();
                
                if (data.buckets) {
                    // æœ‰é…ç½®ï¼Œæ˜¾ç¤ºç¯å¢ƒé€‰æ‹©
                    showSimpleEnvSelectionModal(projectName, data.buckets);
                } else {
                    // æ²¡æœ‰é…ç½®ï¼Œæç¤ºç”¨æˆ·
                    showNotification(`âŒ é¡¹ç›® ${projectName} æœªé…ç½® OSS bucket`);
                }
            } catch (err) {
                console.error('Failed to load project buckets:', err);
                showNotification(`âŒ åŠ è½½é…ç½®å¤±è´¥: ${err.message}`);
            }
        }

        // æ˜¾ç¤ºç®€å•çš„ç¯å¢ƒé€‰æ‹©å¼¹çª—ï¼ˆéå¤šæ¸ é“é¡¹ç›®ï¼‰
        function showSimpleEnvSelectionModal(projectName, buckets) {
            const devBucketText = buckets.dev ? (buckets.dev.name || buckets.dev) : 'æœªé…ç½®';
            const prodBuckets = Array.isArray(buckets.prod) ? buckets.prod : [buckets.prod];
            
            // ç”Ÿäº§ç¯å¢ƒæ˜¾ç¤ºæ–‡æœ¬ï¼ˆå¤šä¸ªbucketæ—¶æ˜¾ç¤ºæ•°é‡æç¤ºï¼‰
            const prodBucketText = prodBuckets.length > 1 
                ? `${prodBuckets.map(b => b.name || b).join(' + ')}` 
                : (prodBuckets[0].name || prodBuckets[0]);
            
            // ç”Ÿäº§ç¯å¢ƒæŒ‰é’® - æ— è®ºå¤šå°‘ä¸ªbucketï¼Œåªæ˜¾ç¤ºä¸€ä¸ªæŒ‰é’®
            const prodButtons = `
                <button onclick="uploadSimpleProjectToMultipleBuckets('${projectName}', 'prod', [${prodBuckets.map(b => '\'' + (b.name || b) + '\'').join(',')}]); closeModal();"
                        style="flex: 1; padding: 24px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: 500; transition: all 0.3s; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(245, 87, 108, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(245, 87, 108, 0.3)';">
                    ğŸš€ ç”Ÿäº§ç¯å¢ƒ${prodBuckets.length > 1 ? ` (${prodBuckets.length}ä¸ª)` : ''}<br><span style="font-size: 0.85em; opacity: 0.9;">${prodBucketText}</span>
                </button>
            `;
            
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #333;">â˜ï¸ é€‰æ‹©ä¸Šä¼ ç¯å¢ƒ</h3>
                    <div style="padding: 20px; border: 1px solid #e0e0e0; border-radius: 12px;">
                        <div style="font-weight: 500; color: #333; margin-bottom: 16px; font-size: 1.05em;">${projectName}</div>
                        <div style="display: flex; gap: 16px; flex-direction: row;">
                            <button onclick="uploadSimpleProject('${projectName}', 'dev', '${devBucketText.replace(/'/g, "\\'")}'); closeModal();"
                                    style="flex: 1; padding: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: 500; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)';">
                                ğŸ“¦ å¼€å‘ç¯å¢ƒ<br><span style="font-size: 0.85em; opacity: 0.9;">${devBucketText}</span>
                            </button>
                            ${prodButtons}
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="closeModal();" 
                                style="padding: 10px 20px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;

            showCustomModal(modalContent);
        }

        // ç®€å•é¡¹ç›®ä¸Šä¼ ï¼ˆæ— æ¸ é“ï¼‰
        async function uploadSimpleProject(projectName, env, bucket) {
            const path = getProjectPath(projectName);
            
            // å…ˆæ£€æŸ¥ build ç›®å½•æ˜¯å¦å­˜åœ¨
            try {
                const checkResponse = await fetch('http://localhost:5178/api/check-build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName, path })
                });
                
                const checkData = await checkResponse.json();
                
                if (!checkData.exists || checkData.isEmpty) {
                    // build ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œç›´æ¥å¼€å§‹æ„å»º
                    showNotification(`ï¿½ ${projectName} éœ€è¦æ„å»ºï¼Œå¼€å§‹æ„å»º...`);
                    
                    // æ‰§è¡Œæ„å»º - ä½¿ç”¨ buildProject å‡½æ•°ï¼Œæ˜¾ç¤ºæ„å»ºè¿›åº¦
                    try {
                        await buildProject(projectName);
                    } catch (buildError) {
                        showNotification('âŒ æ„å»ºå¤±è´¥ï¼Œå·²å–æ¶ˆä¸Šä¼ ');
                        return;
                    }
                    
                    // æ„å»ºå®Œæˆåï¼Œé‡æ–°æ£€æŸ¥ build ç›®å½•
                    const recheckResponse = await fetch('http://localhost:5178/api/check-build', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectName, path })
                    });
                    
                    const recheckData = await recheckResponse.json();
                    if (!recheckData.exists || recheckData.isEmpty) {
                        showNotification('âŒ æ„å»ºå build ç›®å½•ä»ä¸ºç©ºæˆ–ä¸å­˜åœ¨');
                        return;
                    }
                }
                
                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦å¼¹æ¡†
                const modalContent = `
                    <div style="padding: 30px;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">â˜ï¸</div>
                            <h3 style="margin: 0 0 15px 0; color: #333;">æ­£åœ¨ä¸Šä¼  ${projectName}</h3>
                            <div style="padding: 8px 16px; background: #f0f0f0; border-radius: 20px; display: inline-block; margin-bottom: 20px;">
                                <span style="font-size: 0.9em; color: #666;">ç¯å¢ƒ: ${env === 'prod' ? 'ç”Ÿäº§' : 'å¼€å‘'} | Bucket: ${bucket}</span>
                            </div>
                            <div id="upload-progress-text" style="color: #666; margin-bottom: 20px;">å‡†å¤‡ä¸Šä¼ ...</div>
                            <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-bottom: 10px;">
                                <div id="upload-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                            </div>
                            <div id="upload-stats" style="font-size: 0.9em; color: #999;">0 / 0 æ–‡ä»¶</div>
                        </div>
                        <div id="upload-log-container" style="margin-top: 20px; max-height: 350px; overflow-y: auto; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.75em;">
                            <div id="upload-log"></div>
                        </div>
                    </div>
                    <style>
                        #upload-log-container::-webkit-scrollbar { width: 8px; }
                        #upload-log-container::-webkit-scrollbar-track { background: #2d2d2d; }
                        #upload-log-container::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
                    </style>
                `;
                
                showCustomModal(modalContent);
                
                const progressBar = document.getElementById('upload-progress-bar');
                const progressText = document.getElementById('upload-progress-text');
                const statsText = document.getElementById('upload-stats');
                const logContainer = document.getElementById('upload-log-container');
                const logElement = document.getElementById('upload-log');
                
                let totalFiles = 0;
                let uploadedFiles = 0;
                let failedFiles = 0;
                
                // ä½¿ç”¨æµå¼ API
                const response = await fetch('http://localhost:5178/api/oss/upload-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        projectName,
                        path,
                        env,
                        bucket
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'log') {
                                    const logLine = document.createElement('div');
                                    logLine.style.marginBottom = '4px';
                                    logLine.style.color = '#00aaff';
                                    logLine.textContent = 'ğŸ“ ' + data.message;
                                    logElement.appendChild(logLine);
                                    progressText.textContent = data.message;
                                } else if (data.type === 'uploading') {
                                    totalFiles = data.current;
                                    const logLine = document.createElement('div');
                                    logLine.style.marginBottom = '2px';
                                    logLine.style.color = '#ffaa00';
                                    logLine.textContent = `â¬†ï¸  ${data.file}`;
                                    logElement.appendChild(logLine);
                                    progressText.textContent = `æ­£åœ¨ä¸Šä¼ : ${data.file}`;
                                } else if (data.type === 'success') {
                                    uploadedFiles = data.current || (uploadedFiles + 1);
                                    totalFiles = data.total || totalFiles;
                                    const progress = totalFiles > 0 ? (uploadedFiles / totalFiles) * 100 : 0;
                                    progressBar.style.width = progress + '%';
                                    statsText.textContent = `${uploadedFiles} / ${totalFiles} æ–‡ä»¶`;
                                    
                                    const successLine = document.createElement('div');
                                    successLine.style.marginBottom = '2px';
                                    successLine.style.color = '#00ff00';
                                    successLine.textContent = `âœ“ ${data.file}`;
                                    logElement.appendChild(successLine);
                                } else if (data.type === 'error') {
                                    if (data.file) {
                                        failedFiles++;
                                        const logLine = document.createElement('div');
                                        logLine.style.marginBottom = '4px';
                                        logLine.style.color = '#ff4444';
                                        logLine.textContent = `âŒ ${data.file}: ${data.message}`;
                                        logElement.appendChild(logLine);
                                    } else {
                                        progressBar.style.width = '100%';
                                        progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                                        progressText.textContent = 'âŒ ä¸Šä¼ å¤±è´¥';
                                        progressText.style.color = '#ef4444';
                                        
                                        const errorLine = document.createElement('div');
                                        errorLine.style.marginTop = '10px';
                                        errorLine.style.color = '#ff4444';
                                        errorLine.style.fontWeight = 'bold';
                                        errorLine.textContent = 'âŒ ' + data.message;
                                        logElement.appendChild(errorLine);
                                        
                                        showNotification(`âŒ ä¸Šä¼ å¤±è´¥: ${data.message}`);
                                        setTimeout(() => closeModal(), 5000);
                                        return;
                                    }
                                } else if (data.type === 'complete') {
                                    progressBar.style.width = '100%';
                                    progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
                                    progressText.textContent = 'âœ… ä¸Šä¼ å®Œæˆï¼';
                                    progressText.style.color = '#10b981';
                                    
                                    const successLine = document.createElement('div');
                                    successLine.style.marginTop = '10px';
                                    successLine.style.color = '#00ff00';
                                    successLine.style.fontWeight = 'bold';
                                    successLine.textContent = `âœ… ${data.message} (æˆåŠŸ: ${data.uploaded}, å¤±è´¥: ${data.failed})`;
                                    logElement.appendChild(successLine);
                                    
                                    if (data.url) {
                                        const urlLine = document.createElement('div');
                                        urlLine.style.marginTop = '5px';
                                        urlLine.style.color = '#00aaff';
                                        urlLine.textContent = `ğŸ”— ${data.url}`;
                                        logElement.appendChild(urlLine);
                                    }
                                    
                                    showNotification(`âœ… ä¸Šä¼ æˆåŠŸ: ${projectName} (${env})`);
                                    showNotification(`ğŸ“Š å·²ä¸Šä¼  ${data.uploaded} ä¸ªæ–‡ä»¶${data.failed ? `, ${data.failed} ä¸ªå¤±è´¥` : ''}`);
                                    if (data.url) {
                                        showNotification(`ğŸ”— è®¿é—®åœ°å€: ${data.url}`);
                                    }
                                    
                                    // åªæœ‰ç”Ÿäº§ç¯å¢ƒæ‰å¤‡ä»½
                                    if (env === 'prod') {
                                        setTimeout(async () => {
                                            await backupBuildToOSS(projectName, path, bucket);
                                        }, 1000);
                                    }
                                    
                                    setTimeout(() => closeModal(), 5000);
                                }
                                
                                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                logContainer.scrollTop = logContainer.scrollHeight;
                                
                            } catch (e) {
                                console.error('Failed to parse upload SSE data:', e);
                            }
                        }
                    }
                }
                
            } catch (err) {
                showNotification(`âŒ æ“ä½œå¤±è´¥: ${err.message}`);
            }
        }

        // ä¸Šä¼ åˆ°å¤šä¸ªç”Ÿäº§bucketï¼ˆç”¨äº react-agent-website ç­‰éœ€è¦åŒæ—¶ä¸Šä¼ å¤šä¸ªbucketçš„é¡¹ç›®ï¼‰
        async function uploadSimpleProjectToMultipleBuckets(projectName, env, bucketNames) {
            const path = window.PROJECT_PATHS ? window.PROJECT_PATHS[projectName] : `~/Projects/${projectName}`;
            if (!path) {
                showNotification(`âŒ é¡¹ç›® ${projectName} è·¯å¾„æœªæ‰¾åˆ°`);
                return;
            }

            // è·å–å®Œæ•´ bucket é…ç½®
            let buckets = [];
            try {
                const response = await fetch(`http://localhost:5178/api/project-buckets/${projectName}`);
                const data = await response.json();
                if (data.buckets && data.buckets[env]) {
                    const allBuckets = Array.isArray(data.buckets[env]) ? data.buckets[env] : [data.buckets[env]];
                    buckets = allBuckets.filter(b => bucketNames.includes(b.name || b));
                }
            } catch (e) {
                showNotification(`âŒ è·å– bucket é…ç½®å¤±è´¥: ${e.message}`);
                return;
            }

            if (buckets.length === 0) {
                showNotification('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ bucket é…ç½®');
                return;
            }

            // æ˜¾ç¤ºç¡®è®¤å¼¹æ¡†
            const bucketNamesStr = buckets.map(b => b.name || b).join(', ');
            const confirmContent = `
                <div style="padding: 20px; text-align: center;">
                    <h3 style="margin: 0 0 20px 0; color: #333;">â˜ï¸ ç¡®è®¤ä¸Šä¼ </h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-weight: 500; color: #333; margin-bottom: 10px;">${projectName}</div>
                        <div style="color: #666; margin-bottom: 10px;">ç¯å¢ƒ: ${env === 'dev' ? 'å¼€å‘' : 'ç”Ÿäº§'}</div>
                        <div style="color: #666;">Bucket: ${bucketNamesStr}</div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="closeModal(); doUploadSimpleProject('${projectName}', '${env}', [${bucketNames.map(name => '\'' + name + '\'').join(',')}]);" 
                                style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            âœ… ç¡®è®¤ä¸Šä¼ 
                        </button>
                        <button onclick="closeModal();" 
                                style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            showCustomModal(confirmContent);
        }

        // æ‰§è¡Œç®€å•é¡¹ç›®ä¸Šä¼ 
        async function doUploadSimpleProject(projectName, env, bucketNames) {
            const path = window.PROJECT_PATHS ? window.PROJECT_PATHS[projectName] : `~/Projects/${projectName}`;
            
            // è·å–å®Œæ•´ bucket é…ç½®
            let buckets = [];
            try {
                const response = await fetch(`http://localhost:5178/api/project-buckets/${projectName}`);
                const data = await response.json();
                if (data.buckets && data.buckets[env]) {
                    const allBuckets = Array.isArray(data.buckets[env]) ? data.buckets[env] : [data.buckets[env]];
                    buckets = allBuckets.filter(b => bucketNames.includes(b.name || b));
                }
            } catch (e) {
                progressText.textContent = 'âŒ è·å–é…ç½®å¤±è´¥';
                const errorLine = document.createElement('div');
                errorLine.style.marginBottom = '4px';
                errorLine.style.color = '#ff4444';
                errorLine.textContent = `âŒ è·å–é…ç½®å¤±è´¥: ${e.message}`;
                logElement.appendChild(errorLine);
                return;
            }

            if (buckets.length === 0) {
                progressText.textContent = 'âŒ æœªæ‰¾åˆ° bucket';
                const errorLine = document.createElement('div');
                errorLine.style.marginBottom = '4px';
                errorLine.style.color = '#ff4444';
                errorLine.textContent = 'âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ bucket é…ç½®';
                logElement.appendChild(errorLine);
                return;
            }
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦å¼¹æ¡†
            const bucketList = Array.isArray(buckets) ? buckets : [buckets];
            const bucketNamesStr = bucketList.map(b => b.name || b).join(', ');
            
            const modalContent = `
                <div style="padding: 30px;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">â˜ï¸</div>
                        <h3 style="margin: 0 0 15px 0; color: #333;">æ­£åœ¨ä¸Šä¼  ${projectName}</h3>
                        <div style="padding: 8px 16px; background: #f0f0f0; border-radius: 20px; display: inline-block; margin-bottom: 20px;">
                            <span style="font-size: 0.9em; color: #666;">ç¯å¢ƒ: ${env === 'prod' ? 'ç”Ÿäº§' : 'å¼€å‘'} | Buckets: ${bucketNamesStr}</span>
                        </div>
                        <div id="upload-progress-text" style="color: #666; margin-bottom: 20px;">å‡†å¤‡ä¸Šä¼ ...</div>
                        <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-bottom: 10px;">
                            <div id="upload-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                        </div>
                        <div id="upload-stats" style="font-size: 0.9em; color: #999;">0 / 0 æ–‡ä»¶</div>
                    </div>
                    <div id="upload-log-container" style="margin-top: 20px; max-height: 350px; overflow-y: auto; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.75em;">
                        <div id="upload-log"></div>
                    </div>
                </div>
                <style>
                    #upload-log-container::-webkit-scrollbar { width: 8px; }
                    #upload-log-container::-webkit-scrollbar-track { background: #2d2d2d; }
                    #upload-log-container::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
                </style>
            `;
            
            showCustomModal(modalContent);
            
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');
            const statsText = document.getElementById('upload-stats');
            const logElement = document.getElementById('upload-log');
            const logContainer = document.getElementById('upload-log-container');
            
            try {
                // æ£€æŸ¥ build ç›®å½•
                const checkResponse = await fetch('http://localhost:5178/api/check-build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName, path })
                });
                
                const checkData = await checkResponse.json();
                
                if (!checkData.exists || checkData.isEmpty) {
                    // build ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œç›´æ¥å¼€å§‹æ„å»º
                    progressText.textContent = 'ğŸ”¨ æ­£åœ¨æ„å»ºé¡¹ç›®...';
                    const logLine = document.createElement('div');
                    logLine.style.marginBottom = '4px';
                    logLine.style.color = '#ffff00';
                    logLine.textContent = 'ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®...';
                    logElement.appendChild(logLine);
                    
                    // æ‰§è¡Œæ„å»º - ä½¿ç”¨ buildProject å‡½æ•°
                    try {
                        await buildProject(projectName);
                    } catch (buildError) {
                        progressText.textContent = 'âŒ æ„å»ºå¤±è´¥';
                        const errorLine = document.createElement('div');
                        errorLine.style.marginBottom = '4px';
                        errorLine.style.color = '#ff4444';
                        errorLine.textContent = 'âŒ æ„å»ºå¤±è´¥: ' + buildError.message;
                        logElement.appendChild(errorLine);
                        return;
                    }
                    
                    // æ„å»ºå®Œæˆåï¼Œé‡æ–°æ£€æŸ¥ build ç›®å½•
                    const recheckResponse = await fetch('http://localhost:5178/api/check-build', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectName, path })
                    });
                    
                    const recheckData = await recheckResponse.json();
                    if (!recheckData.exists || recheckData.isEmpty) {
                        progressText.textContent = 'âŒ æ„å»ºå build ç›®å½•ä»ä¸ºç©º';
                        const errorLine = document.createElement('div');
                        errorLine.style.marginBottom = '4px';
                        errorLine.style.color = '#ff4444';
                        errorLine.textContent = 'âŒ æ„å»ºå build ç›®å½•ä»ä¸ºç©ºæˆ–ä¸å­˜åœ¨';
                        logElement.appendChild(errorLine);
                        return;
                    }
                }
                
                // å¾ªç¯ä¸Šä¼ åˆ°æ‰€æœ‰ç”Ÿäº§bucketï¼ˆä½¿ç”¨æµå¼APIï¼‰
                const bucketList = Array.isArray(buckets) ? buckets : [buckets];
                progressText.textContent = `â˜ï¸ æ­£åœ¨ä¸Šä¼ åˆ° ${bucketList.length} ä¸ª bucket...`;
                
                let successCount = 0;
                let failCount = 0;
                let totalFiles = 0;
                let uploadedFiles = 0;
                let currentBucketIndex = 0;
                let bucketProgresses = new Array(bucketList.length).fill(0); // æ¯ä¸ªbucketçš„è¿›åº¦
                
                const uploadNextBucket = async () => {
                    if (currentBucketIndex >= bucketList.length) {
                        // æ‰€æœ‰bucketä¸Šä¼ å®Œæˆ
                        const finalProgress = failCount === 0 ? 'ğŸ‰ å…¨éƒ¨ä¸Šä¼ å®Œæˆï¼' : 'âš ï¸ ä¸Šä¼ å®Œæˆï¼Œä½†æœ‰å¤±è´¥';
                        progressText.textContent = finalProgress;
                        progressBar.style.width = '100%';
                        progressBar.style.background = failCount === 0 ? 'linear-gradient(90deg, #00ff00 0%, #00aa00 100%)' : 'linear-gradient(90deg, #ffa500 0%, #ff8c00 100%)';
                        
                        const successLine = document.createElement('div');
                        successLine.style.marginBottom = '4px';
                        successLine.style.color = failCount === 0 ? '#00ff00' : '#ffff00';
                        successLine.textContent = failCount === 0 
                            ? `ğŸ‰ å…¨éƒ¨ä¸Šä¼ å®Œæˆï¼æˆåŠŸ: ${successCount}/${bucketList.length}` 
                            : `âš ï¸ ä¸Šä¼ å®Œæˆï¼ŒæˆåŠŸ: ${successCount}ï¼Œå¤±è´¥: ${failCount}`;
                        logElement.appendChild(successLine);
                        
                        // åªæœ‰ç”Ÿäº§ç¯å¢ƒæ‰å¤‡ä»½ build æ–‡ä»¶å¤¹åˆ°"ä»¥å¾€ç‰ˆæœ¬"ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ª bucketï¼‰
                        if (env === 'prod' && failCount === 0) {
                            const firstBucket = bucketList[0].name || bucketList[0];
                            progressText.textContent = 'ğŸ“¦ æ­£åœ¨å¤‡ä»½ build æ–‡ä»¶å¤¹...';
                            await backupBuildToOSS(projectName, path, firstBucket);
                        }
                        
                        // react-agent-website ç”Ÿäº§ç¯å¢ƒéœ€è¦é¢å¤–æ­¥éª¤ï¼šå¤åˆ¶æ–‡ä»¶åˆ° agent-pro å¹¶ push
                        if (projectName === 'react-agent-website' && env === 'prod' && failCount === 0) {
                            showNotification(`ğŸ“‹ æ­£åœ¨å¤åˆ¶æ–‡ä»¶åˆ° agent-pro...`);
                            
                            try {
                                const copyResponse = await fetch('http://localhost:5178/api/copy-and-push', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        sourcePath: path,
                                        targetProjectPath: '/Users/maiyou001/Project/agent-pro',
                                        commitMessage: `Update from react-agent-website build at ${new Date().toLocaleString('zh-CN')}`
                                    })
                                });
                                
                                const copyData = await copyResponse.json();
                                
                                if (copyData.ok) {
                                    if (copyData.pushed) {
                                        showNotification(`âœ… å·²å¤åˆ¶ ${copyData.copiedFiles} ä¸ªæ–‡ä»¶åˆ° agent-pro å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“`);
                                        showNotification(`ğŸ“ Git: ${copyData.changedFiles} ä¸ªæ–‡ä»¶æœ‰æ”¹åŠ¨`);
                                    } else {
                                        showNotification(`â„¹ï¸ ${copyData.message}`);
                                    }
                                } else {
                                    showNotification(`âš ï¸ å¤åˆ¶åˆ° agent-pro å¤±è´¥: ${copyData.error}`);
                                }
                            } catch (copyErr) {
                                showNotification(`âš ï¸ å¤åˆ¶åˆ° agent-pro å¤±è´¥: ${copyErr.message}`);
                            }
                        }
                        
                        return;
                    }
                    
                    const bucket = bucketList[currentBucketIndex];
                    const bucketName = bucket.name || bucket;
                    
                    // é‡ç½®å½“å‰bucketçš„æ–‡ä»¶è®¡æ•°
                    uploadedFiles = 0;
                    totalFiles = 0;
                    
                    progressText.textContent = `ğŸ“¤ æ­£åœ¨ä¸Šä¼ åˆ°: ${bucketName}... (${currentBucketIndex + 1}/${bucketList.length})`;
                    const logLine = document.createElement('div');
                    logLine.style.marginBottom = '4px';
                    logLine.style.color = '#00aaff';
                    logLine.textContent = `ğŸ“¤ å¼€å§‹ä¸Šä¼ åˆ° ${bucketName}...`;
                    logElement.appendChild(logLine);
                    
                    try {
                        // ä½¿ç”¨æµå¼APIä¸Šä¼ åˆ°å½“å‰bucket
                        const uploadResponse = await fetch('http://localhost:5178/api/oss/upload-stream', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                projectName,
                                path,
                                env,
                                bucket: bucketName
                            })
                        });
                        
                        const reader = uploadResponse.body.getReader();
                        const decoder = new TextDecoder();
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            
                            if (done) break;
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        
                                        if (data.type === 'log') {
                                            const logLine = document.createElement('div');
                                            logLine.style.marginBottom = '4px';
                                            logLine.style.color = '#00aaff';
                                            logLine.textContent = `ğŸ“ ${bucketName}: ${data.message}`;
                                            logElement.appendChild(logLine);
                                        } else if (data.type === 'uploading') {
                                            const uploadLine = document.createElement('div');
                                            uploadLine.style.marginBottom = '2px';
                                            uploadLine.style.color = '#ffaa00';
                                            uploadLine.textContent = `â¬†ï¸ ${bucketName}: ${data.file}`;
                                            logElement.appendChild(uploadLine);
                                        } else if (data.type === 'success') {
                                            uploadedFiles++;
                                            totalFiles = Math.max(totalFiles, data.total || uploadedFiles);
                                            
                                            // æ›´æ–°å½“å‰bucketçš„è¿›åº¦
                                            const bucketTotal = data.total || 1;
                                            const bucketUploaded = Math.min(uploadedFiles, bucketTotal);
                                            bucketProgresses[currentBucketIndex] = bucketUploaded / bucketTotal;
                                            
                                            // è®¡ç®—æ•´ä½“è¿›åº¦ï¼šå·²å®Œæˆbucketçš„è¿›åº¦(100%) + å½“å‰bucketçš„è¿›åº¦
                                            const completedBucketsProgress = currentBucketIndex / bucketList.length;
                                            const currentBucketProgress = bucketProgresses[currentBucketIndex] / bucketList.length;
                                            const overallProgress = (completedBucketsProgress + currentBucketProgress) * 100;
                                            
                                            progressBar.style.width = Math.min(overallProgress, 95) + '%';
                                            statsText.textContent = `Bucket ${currentBucketIndex + 1}/${bucketList.length}: ${Math.round(bucketProgresses[currentBucketIndex] * 100)}% (${uploadedFiles}/${totalFiles} æ–‡ä»¶)`;
                                        } else if (data.type === 'error') {
                                            if (data.file) {
                                                const errorLine = document.createElement('div');
                                                errorLine.style.marginBottom = '4px';
                                                errorLine.style.color = '#ff4444';
                                                errorLine.textContent = `âŒ ${bucketName}: ${data.file} - ${data.message}`;
                                                logElement.appendChild(errorLine);
                                            } else {
                                                progressText.textContent = `âŒ ${bucketName}: ä¸Šä¼ å¤±è´¥`;
                                                const errorLine = document.createElement('div');
                                                errorLine.style.marginBottom = '4px';
                                                errorLine.style.color = '#ff4444';
                                                errorLine.textContent = `âŒ ${bucketName}: ${data.message}`;
                                                logElement.appendChild(errorLine);
                                            }
                                        } else if (data.type === 'complete') {
                                            successCount++;
                                            // æ ‡è®°å½“å‰bucketå®Œæˆ
                                            bucketProgresses[currentBucketIndex] = 1.0;
                                            
                                            const successLine = document.createElement('div');
                                            successLine.style.marginBottom = '4px';
                                            successLine.style.color = '#00ff00';
                                            successLine.textContent = `âœ… ${bucketName}: ä¸Šä¼ æˆåŠŸ (${data.uploaded} ä¸ªæ–‡ä»¶)`;
                                            logElement.appendChild(successLine);
                                            
                                            if (data.url) {
                                                const urlLine = document.createElement('div');
                                                urlLine.style.marginBottom = '4px';
                                                urlLine.style.color = '#8888ff';
                                                urlLine.textContent = `ğŸ”— ${bucketName}: ${data.url}`;
                                                logElement.appendChild(urlLine);
                                            }
                                            
                                            // æ›´æ–°æ•´ä½“è¿›åº¦æ˜¾ç¤º
                                            const completedBucketsProgress = (currentBucketIndex + 1) / bucketList.length;
                                            const overallProgress = completedBucketsProgress * 100;
                                            progressBar.style.width = Math.min(overallProgress, 95) + '%';
                                            statsText.textContent = `Bucket ${currentBucketIndex + 1}/${bucketList.length}: 100% (å®Œæˆ)`;
                                            
                                            // ç»§ç»­ä¸Šä¼ ä¸‹ä¸€ä¸ªbucket
                                            currentBucketIndex++;
                                            setTimeout(uploadNextBucket, 500); // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                                            return;
                                        }
                                        
                                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                        logContainer.scrollTop = logContainer.scrollHeight;
                                        
                                    } catch (e) {
                                        console.error('Failed to parse upload SSE data:', e);
                                    }
                                }
                            }
                        }
                        
                    } catch (error) {
                        failCount++;
                        // æ ‡è®°å½“å‰bucketå¤±è´¥
                        bucketProgresses[currentBucketIndex] = 0;
                        
                        progressText.textContent = `âŒ ${bucketName}: ç½‘ç»œé”™è¯¯`;
                        const errorLine = document.createElement('div');
                        errorLine.style.marginBottom = '4px';
                        errorLine.style.color = '#ff4444';
                        errorLine.textContent = `âŒ ${bucketName}: ç½‘ç»œé”™è¯¯ - ${error.message}`;
                        logElement.appendChild(errorLine);
                        
                        // ç»§ç»­ä¸Šä¼ ä¸‹ä¸€ä¸ªbucket
                        currentBucketIndex++;
                        setTimeout(uploadNextBucket, 500);
                        return;
                    }
                };
                
                // å¼€å§‹ä¸Šä¼ ç¬¬ä¸€ä¸ªbucket
                uploadNextBucket();
                
            } catch (err) {
                showNotification(`âŒ æ“ä½œå¤±è´¥: ${err.message}`);
            }
        }

        // å¤‡ä»½ build æ–‡ä»¶å¤¹åˆ° OSS çš„"ä»¥å¾€ç‰ˆæœ¬"ç›®å½•
        async function backupBuildToOSS(projectName, projectPath, bucketName) {
            try {
                showNotification(`ğŸ“¦ æ­£åœ¨å¤‡ä»½ ${projectName} çš„æ„å»ºæ–‡ä»¶...`);
                
                const backupResponse = await fetch('http://localhost:5178/api/backup-build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectName,
                        projectPath,
                        bucketName
                    })
                });
                
                const backupData = await backupResponse.json();
                
                if (backupData.ok) {
                    showNotification(`âœ… å¤‡ä»½æˆåŠŸ: ${backupData.fileName} (${backupData.size})`);
                    showNotification(`ğŸ“ ä¿å­˜ä½ç½®: ${backupData.ossPath}`);
                } else {
                    showNotification(`âš ï¸ å¤‡ä»½å¤±è´¥: ${backupData.error}`);
                }
            } catch (err) {
                showNotification(`âš ï¸ å¤‡ä»½å¤±è´¥: ${err.message}`);
            }
        }


        // æ˜¾ç¤ºæ¸ é“å’Œç¯å¢ƒé€‰æ‹©å¼¹çª—
        function showChannelEnvSelectionModal(projectName, channels, action) {
            // åªæ˜¾ç¤ºæŒ‡å®šçš„4ä¸ªæ¸ é“
            const targetChannels = ['hg', '05', '01', 'hz'];
            const filteredChannels = Object.fromEntries(
                Object.entries(channels).filter(([id]) => targetChannels.includes(id))
            );

            const channelOptions = Object.entries(filteredChannels).map(([id, config]) => {
                const hasBuckets = config.buckets && typeof config.buckets === 'object';
                const devBucket = hasBuckets && config.buckets.dev ? (config.buckets.dev.name || config.buckets.dev) : 'æœªé…ç½®';
                const prodBucket = hasBuckets && config.buckets.prod ? (config.buckets.prod.name || config.buckets.prod) : 'æœªé…ç½®';
                
                return `
                    <div class="channel-item" style="padding: 16px; border-bottom: 1px solid #f0f0f0;">
                        <div style="font-weight: 500; color: #333; margin-bottom: 12px;">${config.name}</div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="executeChannelAction('${projectName}', '${id}', 'dev', '${action}'); closeModal();"
                                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
                                ğŸ“¦ å¼€å‘ç¯å¢ƒ<br><span style="font-size: 0.8em; opacity: 0.9;">${devBucket}</span>
                            </button>
                            <button onclick="executeChannelAction('${projectName}', '${id}', 'prod', '${action}'); closeModal();"
                                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
                                ğŸš€ ç”Ÿäº§ç¯å¢ƒ<br><span style="font-size: 0.8em; opacity: 0.9;">${prodBucket}</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #333;">
                        ${action === 'upload' ? 'â˜ï¸ é€‰æ‹©ä¸Šä¼ æ¸ é“å’Œç¯å¢ƒ' : 'ğŸ”¨ é€‰æ‹©æ„å»ºæ¸ é“'}
                    </h3>
                    <div style="border-radius: 12px; overflow: hidden; border: 1px solid #e0e0e0;">
                        ${channelOptions}
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="closeModal();" 
                                style="padding: 10px 20px; background: #e0e0e0; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;

            showCustomModal(modalContent);
        }

        // æ‰§è¡Œæ¸ é“ç›¸å…³æ“ä½œï¼ˆæ„å»ºæˆ–ä¸Šä¼ ï¼‰
        function executeChannelAction(projectName, channelId, env, action) {
            if (action === 'upload') {
                // ç‚¹å‡»ä¸Šä¼ æ—¶ç›´æ¥å¼¹å‡ºBuildå¼¹æ¡†
                buildWithChannel(projectName, channelId, true);
            } else if (action === 'build') {
                buildWithChannel(projectName, channelId, false);
            }
        }

        // æŒ‰æ¸ é“å’Œç¯å¢ƒä¸Šä¼ 
        async function uploadWithChannel(projectName, channelId, env) {
            const path = getProjectPath(projectName);
            
            // è·å– bucket ä¿¡æ¯
            try {
                const bucketResponse = await fetch(`http://localhost:5178/api/oss/get-bucket-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName, channelId, env })
                });
                const bucketData = await bucketResponse.json();
                
                if (!bucketData.buckets || bucketData.buckets.length === 0) {
                    showNotification('âŒ æœªæ‰¾åˆ°å¯ç”¨çš„ bucket é…ç½®');
                    return;
                }
                
                const buckets = bucketData.buckets;
                const bucketNames = buckets.map(b => b.name).join(', ');
                
                // æ˜¾ç¤ºç¡®è®¤å¼¹æ¡†
                const confirmContent = `
                    <div style="padding: 20px; text-align: center;">
                        <h3 style="margin: 0 0 20px 0; color: #333;">â˜ï¸ ç¡®è®¤ä¸Šä¼ </h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-weight: 500; color: #333; margin-bottom: 10px;">${projectName}</div>
                            <div style="color: #666; margin-bottom: 10px;">æ¸ é“: ${channelId} | ç¯å¢ƒ: ${env === 'dev' ? 'å¼€å‘' : 'ç”Ÿäº§'}</div>
                            <div style="color: #666;">Bucket: ${bucketNames}</div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="doUploadWithChannel('${projectName}', '${channelId}', '${env}');" 
                                    style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                âœ… ç¡®è®¤ä¸Šä¼ 
                            </button>
                            <button onclick="closeModal();" 
                                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                `;
                showCustomModal(confirmContent);
            } catch (error) {
                console.error('Error getting bucket info:', error);
                showNotification('âŒ è·å– bucket é…ç½®å¤±è´¥');
            }
        }

        // æ‰§è¡Œå¸¦æ¸ é“çš„ä¸Šä¼ 
        async function doUploadWithChannel(projectName, channelId, env) {
            // å…ˆå…³é—­ä¹‹å‰çš„å¼¹æ¡†
            closeModal();
            
            const path = getProjectPath(projectName);
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦å¼¹æ¡†
            const modalContent = `
                <div style="padding: 30px;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">â˜ï¸</div>
                        <h3 style="margin: 0 0 15px 0; color: #333;">æ­£åœ¨ä¸Šä¼  ${projectName}</h3>
                        <div style="padding: 8px 16px; background: #f0f0f0; border-radius: 20px; display: inline-block; margin-bottom: 20px;">
                            <span style="font-size: 0.9em; color: #666;">æ¸ é“: ${channelId} | ç¯å¢ƒ: ${env === 'dev' ? 'å¼€å‘' : 'ç”Ÿäº§'}</span>
                        </div>
                        <div id="upload-progress-text" style="color: #666; margin-bottom: 20px;">å‡†å¤‡ä¸Šä¼ ...</div>
                        <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-bottom: 10px;">
                            <div id="upload-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                        </div>
                        <div id="upload-stats" style="font-size: 0.9em; color: #999;">0 / 0 æ–‡ä»¶</div>
                    </div>
                    <div id="upload-log-container" style="margin-top: 20px; height: 300px; overflow-y: auto; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.75em;">
                        <div id="upload-log"></div>
                    </div>
                </div>
                <style>
                    #upload-log-container::-webkit-scrollbar { width: 8px; }
                    #upload-log-container::-webkit-scrollbar-track { background: #2d2d2d; }
                    #upload-log-container::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
                </style>
            `;
            
            showCustomModal(modalContent);
            
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');
            const statsText = document.getElementById('upload-stats');
            const logElement = document.getElementById('upload-log');
            const logContainer = document.getElementById('upload-log-container');
            
            try {
                // å¼€å§‹ä¸Šä¼  - ä½¿ç”¨æµå¼ API
                progressText.textContent = 'â˜ï¸ æ­£åœ¨ä¸Šä¼ ...';
                const logLine = document.createElement('div');
                logLine.style.marginBottom = '4px';
                logLine.style.color = '#00aaff';
                logLine.textContent = 'â˜ï¸ å¼€å§‹ä¸Šä¼ æ–‡ä»¶...';
                logElement.appendChild(logLine);
                
                const response = await fetch('http://localhost:5178/api/upload-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        projectName,
                        path,
                        channelId,
                        env
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    
                    // å¤„ç†å®Œæ•´çš„SSEæ¶ˆæ¯
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6);
                                const data = JSON.parse(jsonStr);
                                
                                // æ›´æ–°è¿›åº¦
                                if (data.type === 'start') {
                                    progressText.textContent = data.message;
                                    statsText.textContent = `0 / ${data.total} æ–‡ä»¶`;
                                } else if (data.type === 'uploading') {
                                    progressText.textContent = `æ­£åœ¨ä¸Šä¼ : ${data.file}`;
                                    progressBar.style.width = data.progress + '%';
                                } else if (data.type === 'uploaded') {
                                    progressBar.style.width = data.progress + '%';
                                    statsText.textContent = `${data.uploaded} / ${data.total} æ–‡ä»¶`;
                                    
                                    const successLine = document.createElement('div');
                                    successLine.style.marginBottom = '2px';
                                    successLine.style.color = '#00ff00';
                                    successLine.textContent = `âœ“ ${data.file}`;
                                    logElement.appendChild(successLine);
                                } else if (data.type === 'failed') {
                                    progressBar.style.width = data.progress + '%';
                                    statsText.textContent = `${data.uploaded} / ${data.total} æ–‡ä»¶`;
                                    
                                    const errorLine = document.createElement('div');
                                    errorLine.style.marginBottom = '2px';
                                    errorLine.style.color = '#ff4444';
                                    errorLine.textContent = `âœ— ${data.file}: ${data.error}`;
                                    logElement.appendChild(errorLine);
                                } else if (data.type === 'complete') {
                                    progressText.textContent = 'âœ… ä¸Šä¼ æˆåŠŸ';
                                    progressBar.style.width = '100%';
                                    progressBar.style.background = 'linear-gradient(90deg, #00ff00 0%, #00aa00 100%)';
                                    statsText.textContent = `${data.uploaded} / ${data.uploaded + data.failed} æ–‡ä»¶`;
                                    
                                    const completeLine = document.createElement('div');
                                    completeLine.style.marginTop = '10px';
                                    completeLine.style.color = '#00ff00';
                                    completeLine.style.fontWeight = 'bold';
                                    completeLine.textContent = data.message;
                                    logElement.appendChild(completeLine);
                                    
                                    if (data.results) {
                                        data.results.forEach(result => {
                                            if (result.status === 'failed') {
                                                const resultLine = document.createElement('div');
                                                resultLine.style.marginBottom = '2px';
                                                resultLine.style.color = '#ff4444';
                                                resultLine.textContent = `âœ— ${result.file}: ${result.error}`;
                                                logElement.appendChild(resultLine);
                                            }
                                        });
                                    }
                                    
                                    // åªæœ‰ç”Ÿäº§ç¯å¢ƒæ‰å¤‡ä»½ build æ–‡ä»¶å¤¹
                                    if (env === 'prod') {
                                        progressText.textContent = 'ğŸ“¦ æ­£åœ¨å¤‡ä»½ build æ–‡ä»¶å¤¹...';
                                        // è¿™é‡Œéœ€è¦è·å–bucketä¿¡æ¯ï¼Œæš‚æ—¶ç®€åŒ–å¤„ç†
                                        setTimeout(() => {
                                            progressText.textContent = 'âœ… å¤‡ä»½å®Œæˆ';
                                        }, 1000);
                                    }
                                } else if (data.type === 'error') {
                                    progressText.textContent = 'âŒ ä¸Šä¼ å¤±è´¥';
                                    const errorLine = document.createElement('div');
                                    errorLine.style.marginBottom = '4px';
                                    errorLine.style.color = '#ff4444';
                                    errorLine.textContent = `âŒ ä¸Šä¼ å¤±è´¥: ${data.message}`;
                                    logElement.appendChild(errorLine);
                                }
                                
                                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                logContainer.scrollTop = logContainer.scrollHeight;
                                
                            } catch (e) {
                                console.error('Failed to parse SSE data:', e);
                            }
                        }
                    }
                }
                
                // å¤„ç†å‰©ä½™çš„ç¼“å†²åŒºæ•°æ®
                if (buffer.trim()) {
                    const lines = buffer.split('\n\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6);
                                if (jsonStr.trim()) {
                                    const data = JSON.parse(jsonStr);
                                    
                                    // å¤„ç†å‰©ä½™æ•°æ®ä¸­çš„æ¶ˆæ¯ï¼ˆè¿™é‡Œå¯ä»¥å¤åˆ¶ä¸Šé¢çš„å¤„ç†é€»è¾‘ï¼‰
                                    if (data.type === 'complete') {
                                        progressText.textContent = 'âœ… ä¸Šä¼ æˆåŠŸ';
                                        progressBar.style.width = '100%';
                                        progressBar.style.background = 'linear-gradient(90deg, #00ff00 0%, #00aa00 100%)';
                                        statsText.textContent = `${data.uploaded} / ${data.uploaded + data.failed} æ–‡ä»¶`;
                                        
                                        const completeLine = document.createElement('div');
                                        completeLine.style.marginTop = '10px';
                                        completeLine.style.color = '#00ff00';
                                        completeLine.style.fontWeight = 'bold';
                                        completeLine.textContent = data.message;
                                        logElement.appendChild(completeLine);
                                        
                                        if (data.results) {
                                            data.results.forEach(result => {
                                                if (result.status === 'failed') {
                                                    const resultLine = document.createElement('div');
                                                    resultLine.style.marginBottom = '2px';
                                                    resultLine.style.color = '#ff4444';
                                                    resultLine.textContent = `âœ— ${result.file}: ${result.error}`;
                                                    logElement.appendChild(resultLine);
                                                }
                                            });
                                        }
                                        
                                        // åªæœ‰ç”Ÿäº§ç¯å¢ƒæ‰å¤‡ä»½ build æ–‡ä»¶å¤¹
                                        if (env === 'prod') {
                                            progressText.textContent = 'ğŸ“¦ æ­£åœ¨å¤‡ä»½ build æ–‡ä»¶å¤¹...';
                                            setTimeout(() => {
                                                progressText.textContent = 'âœ… å¤‡ä»½å®Œæˆ';
                                            }, 1000);
                                        }
                                    }
                                    
                                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                    logContainer.scrollTop = logContainer.scrollHeight;
                                }
                            } catch (e) {
                                console.error('Failed to parse remaining SSE data:', e);
                            }
                        }
                    }
                }
            } catch (err) {
                progressText.textContent = 'âŒ æ“ä½œå¤±è´¥';
                const errorLine = document.createElement('div');
                errorLine.style.marginBottom = '4px';
                errorLine.style.color = '#ff4444';
                errorLine.textContent = `âŒ æ“ä½œå¤±è´¥: ${err.message}`;
                logElement.appendChild(errorLine);
            }
        }


        // é€šè¿‡åç«¯æ‰§è¡Œæ‹‰å–
        function backendPull(projectName) {
            const path = getProjectPath(projectName);
            showNotification('â³ æ‹‰å–ä¸­: ' + projectName);
            fetch('http://localhost:5178/api/git/pull', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) throw new Error(data.error || 'å¤±è´¥');
                showNotification('âœ… æ‹‰å–å®Œæˆ: ' + projectName);
                const el = document.querySelector(`[data-project="${projectName}"]`);
                if (el && data.lastCommitTime) {
                    const t = el.querySelector('.project-time');
                    t.setAttribute('data-time', data.lastCommitTime);
                    t.textContent = 'æœ€åæ›´æ–°: ' + formatRelativeTime(data.lastCommitTime);
                }
                if (el && data.status) {
                    updateProjectStatus(el, data.status.modified||0, data.status.added||0, data.status.deleted||0);
                }
            })
            .catch(e => showNotification('âŒ æ‹‰å–å¤±è´¥: ' + e.message));
        }

        // é€šè¿‡åç«¯æ‰§è¡Œæ¨é€
        function backendPush(projectName) {
            const path = getProjectPath(projectName);
            showNotification('â³ æ¨é€ä¸­: ' + projectName);
            fetch('http://localhost:5178/api/git/push', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            })
            .then(r => r.json())
            .then(data => {
                if (!data.ok) throw new Error(data.error || 'å¤±è´¥');
                showNotification('âœ… æ¨é€å®Œæˆ: ' + projectName);
                const el = document.querySelector(`[data-project="${projectName}"]`);
                if (el && data.lastCommitTime) {
                    const t = el.querySelector('.project-time');
                    t.setAttribute('data-time', data.lastCommitTime);
                    t.textContent = 'æœ€åæ›´æ–°: ' + formatRelativeTime(data.lastCommitTime);
                }
                if (el && data.status) {
                    updateProjectStatus(el, data.status.modified||0, data.status.added||0, data.status.deleted||0);
                }
            })
            .catch(e => showNotification('âŒ æ¨é€å¤±è´¥: ' + e.message));
        }

        // æ˜¾ç¤ºå‘½ä»¤æ¨¡æ€æ¡†
        function showCommandModal(title, message, command) {
            const content = `
                <div style="padding: 20px;">
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 0.9em;">${message}</pre>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="copyCommand('${command.replace(/'/g, "\\'")}'); showNotification('ğŸ“‹ å‘½ä»¤å·²å¤åˆ¶ï¼')" 
                                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ“‹ å¤åˆ¶å‘½ä»¤
                        </button>
                        <button onclick="executeCommand('${command.replace(/'/g, "\\'")}', '${title}')" 
                                style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            â–¶ï¸ æ‰§è¡Œå‘½ä»¤
                        </button>
                    </div>
                </div>
            `;
            
            showModal(title, content, '');
        }

        // å¤åˆ¶å‘½ä»¤åˆ°å‰ªè´´æ¿
        function copyCommand(command) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(command);
            } else {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = command;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }

        // æ‰§è¡Œå‘½ä»¤ï¼ˆæç¤ºç”¨æˆ·åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œï¼‰
        function executeCommand(command, title) {
            const instructions = `
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ’»</div>
                    <h3 style="margin-bottom: 15px;">è¯·åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</h3>
                    <div style="background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: left;">
                        <code style="font-family: 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word;">${command}</code>
                    </div>
                    <div style="color: #666; font-size: 0.9em; margin-top: 15px;">
                        ğŸ’¡ æç¤ºï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨ç»ˆç«¯ä¸­è¿è¡Œå‘½ä»¤
                    </div>
                    <button onclick="copyCommand('${command.replace(/'/g, "\\'")}'); showNotification('ğŸ“‹ å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')" 
                            style="margin-top: 20px; padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em;">
                        ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿
                    </button>
                </div>
            `;
            
            closeModal();
            setTimeout(() => {
                showModal('ğŸš€ ' + title, instructions, '<button onclick="closeModal()" class="modal-button">å…³é—­</button>');
            }, 100);
        }

        // ==================== é¡¹ç›®æ—¶é—´å’ŒçŠ¶æ€æ›´æ–° ====================

        // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) {
                return 'åˆšåˆš';
            } else if (diffMin < 60) {
                return `${diffMin} åˆ†é’Ÿå‰`;
            } else if (diffHour < 24) {
                return `${diffHour} å°æ—¶å‰`;
            } else if (diffDay === 1) {
                return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDay < 7) {
                return `${diffDay} å¤©å‰`;
            } else if (diffDay < 30) {
                const weeks = Math.floor(diffDay / 7);
                return `${weeks} å‘¨å‰`;
            } else if (diffDay < 365) {
                const months = Math.floor(diffDay / 30);
                return `${months} ä¸ªæœˆå‰`;
            } else {
                const years = Math.floor(diffDay / 365);
                return `${years} å¹´å‰`;
            }
        }

        // æ›´æ–°æ‰€æœ‰é¡¹ç›®çš„æ—¶é—´æ˜¾ç¤º
        function updateProjectTimes() {
            document.querySelectorAll('.project-time').forEach(timeElement => {
                const dateString = timeElement.getAttribute('data-time');
                if (dateString) {
                    timeElement.textContent = 'æœ€åæ›´æ–°: ' + formatRelativeTime(dateString);
                }
            });
        }

        // æ¨¡æ‹Ÿè·å–GitçŠ¶æ€ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦åç«¯æ”¯æŒï¼‰
        function updateProjectStatus(projectElement, modified, added, deleted) {
            const statusDiv = projectElement.querySelector('.project-status');
            
            // éšè—æ‰€æœ‰çŠ¶æ€æ ‡ç­¾
            statusDiv.querySelectorAll('.status-badge').forEach(badge => {
                badge.style.display = 'none';
            });

            // æ ¹æ®æ•°æ®æ˜¾ç¤ºå¯¹åº”çš„æ ‡ç­¾
            if (modified > 0) {
                const modifiedBadge = statusDiv.querySelector('.status-badge.modified');
                modifiedBadge.style.display = 'inline-flex';
                modifiedBadge.querySelector('.modified-count').textContent = modified;
            }
            
            if (added > 0) {
                const addedBadge = statusDiv.querySelector('.status-badge.added');
                addedBadge.style.display = 'inline-flex';
                addedBadge.querySelector('.added-count').textContent = added;
            }
            
            if (deleted > 0) {
                const deletedBadge = statusDiv.querySelector('.status-badge.deleted');
                deletedBadge.style.display = 'inline-flex';
                deletedBadge.querySelector('.deleted-count').textContent = deleted;
            }

            // å¦‚æœéƒ½ä¸º0ï¼Œæ˜¾ç¤º"æ— å˜åŒ–"
            if (modified === 0 && added === 0 && deleted === 0) {
                statusDiv.querySelector('.status-badge.clean').style.display = 'inline-flex';
            }
        }

        // åŠ è½½é¡¹ç›®çš„æ¸ é“é…ç½®
        async function loadProjectChannels(projectName) {
            try {
                const response = await fetch(`http://localhost:5178/api/channels/${projectName}`);
                const data = await response.json();
                
                if (data.channels && Object.keys(data.channels).length > 0) {
                    // æ˜¾ç¤ºæ¸ é“é€‰æ‹©å™¨
                    const selector = document.querySelector(`.channel-selector[data-project="${projectName}"]`);
                    if (selector) {
                        selector.style.display = 'inline-block';
                        
                        // å¡«å……æ¸ é“åˆ—è¡¨
                        const channelList = document.getElementById(`channel-list-${projectName}`);
                        channelList.innerHTML = Object.entries(data.channels).map(([id, config]) => `
                            <div class="channel-item" onclick="buildWithChannel('${projectName}', '${id}', false)">
                                <div class="channel-name">${config.name}</div>
                                <div class="channel-id">${id}</div>
                            </div>
                        `).join('');
                    }
                }
            } catch (err) {
                console.error('Failed to load channels:', err);
            }
        }

        // åˆ‡æ¢æ¸ é“ä¸‹æ‹‰èœå•
        function toggleChannelDropdown(projectName) {
            const dropdown = document.getElementById(`channel-dropdown-${projectName}`);
            const allDropdowns = document.querySelectorAll('.channel-dropdown');
            
            // å…³é—­å…¶ä»–ä¸‹æ‹‰èœå•
            allDropdowns.forEach(d => {
                if (d.id !== `channel-dropdown-${projectName}`) {
                    d.classList.remove('show');
                }
            });
            
            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
            dropdown.classList.toggle('show');
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            if (dropdown.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!e.target.closest('.channel-selector')) {
                            dropdown.classList.remove('show');
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                }, 0);
            }
        }

        // ä½¿ç”¨æŒ‡å®šæ¸ é“æ„å»ºé¡¹ç›®
        async function buildWithChannel(projectName, channel, showEnvSelection = false) {
            return new Promise((resolve, reject) => {
                const dropdown = document.getElementById(`channel-dropdown-${projectName}`);
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
                
                const channelBtn = document.getElementById(`current-channel-${projectName}`);
                let originalText = '';
                if (channelBtn) {
                    originalText = channelBtn.innerHTML;
                    channelBtn.innerHTML = 'â³ æ„å»ºä¸­...';
                    channelBtn.parentElement.disabled = true;
                }
                
                // æ˜¾ç¤ºæ„å»ºè¿›åº¦å¼¹æ¡†
                const modalContent = `
                    <div style="padding: 30px;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”¨</div>
                            <h3 style="margin: 0 0 15px 0; color: #333;">æ­£åœ¨æ„å»º ${projectName}</h3>
                            <div style="padding: 8px 16px; background: #f0f0f0; border-radius: 20px; display: inline-block; margin-bottom: 20px;">
                                <span style="font-size: 0.9em; color: #666;">æ¸ é“: ${channel}</span>
                            </div>
                            <div id="build-progress-text" style="color: #666; margin-bottom: 20px;">å‡†å¤‡åˆ‡æ¢æ¸ é“...</div>
                            <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-bottom: 20px;">
                                <div id="build-progress-bar" style="width: 10%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div id="build-log-container" style="margin-top: 20px; max-height: 350px; overflow-y: auto; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.8em;">
                            <div id="build-log"></div>
                        </div>
                    </div>
                    <style>
                        #build-log-container::-webkit-scrollbar { width: 8px; }
                        #build-log-container::-webkit-scrollbar-track { background: #2d2d2d; }
                        #build-log-container::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
                    </style>
                `;
                
                showCustomModal(modalContent);
                
                const progressBar = document.getElementById('build-progress-bar');
                const progressText = document.getElementById('build-progress-text');
                const logContainer = document.getElementById('build-log-container');
                const logElement = document.getElementById('build-log');
                
                let progress = 10;
                
                (async () => {
                    try {
                        // ä½¿ç”¨æµå¼ API
                        const response = await fetch('http://localhost:5178/api/build-stream', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ projectName, channel })
                        });
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        progressBar.style.width = '20%';
                        progressText.textContent = 'æ­£åœ¨æ„å»º...';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            
                            if (done) break;
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        
                                        // æ›´æ–°è¿›åº¦
                                        if (progress < 90) {
                                            progress += 2;
                                            progressBar.style.width = progress + '%';
                                        }
                                        
                                        // æ·»åŠ æ—¥å¿—
                                        if (data.type === 'log' || data.type === 'stdout') {
                                            const logLine = document.createElement('div');
                                            logLine.style.marginBottom = '4px';
                                            logLine.style.color = '#00ff00';
                                            logLine.textContent = '> ' + data.message;
                                            logElement.appendChild(logLine);
                                        } else if (data.type === 'stderr') {
                                            const logLine = document.createElement('div');
                                            logLine.style.marginBottom = '4px';
                                            logLine.style.color = '#ffaa00';
                                            logLine.textContent = 'âš  ' + data.message;
                                            logElement.appendChild(logLine);
                                        } else if (data.type === 'success') {
                                            progressBar.style.width = '100%';
                                            progressBar.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
                                            progressText.textContent = 'âœ… æ„å»ºæˆåŠŸï¼';
                                            progressText.style.color = '#10b981';
                                            
                                            if (channelBtn) {
                                                channelBtn.innerHTML = 'âœ… æ„å»ºæˆåŠŸ';
                                            }
                                            
                                            const successLine = document.createElement('div');
                                            successLine.style.marginTop = '10px';
                                            successLine.style.color = '#00ff00';
                                            successLine.style.fontWeight = 'bold';
                                            successLine.textContent = 'âœ… ' + data.message;
                                            logElement.appendChild(successLine);
                                            
                                            showNotification(`âœ… æ„å»ºæˆåŠŸ: ${projectName} (${channel})`);
                                            
                                            setTimeout(() => {
                                                closeModal();
                                                if (channelBtn) {
                                                    channelBtn.innerHTML = originalText;
                                                }
                                                // æ„å»ºæˆåŠŸåæ ¹æ®ä¸Šä¸‹æ–‡å†³å®šæ˜¯å¦æ˜¾ç¤ºä¸Šä¼ ç¯å¢ƒé€‰æ‹©å¼¹æ¡†
                                                if (showEnvSelection) {
                                                    showChannelEnvSelection(projectName, channel);
                                                }
                                                resolve(true);
                                            }, 2000);
                                        } else if (data.type === 'error') {
                                            progressBar.style.width = '100%';
                                            progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                                            progressText.textContent = 'âŒ æ„å»ºå¤±è´¥';
                                            progressText.style.color = '#ef4444';
                                            
                                            if (channelBtn) {
                                                channelBtn.innerHTML = 'âŒ æ„å»ºå¤±è´¥';
                                            }
                                            
                                            const errorLine = document.createElement('div');
                                            errorLine.style.marginTop = '10px';
                                            errorLine.style.color = '#ff4444';
                                            errorLine.style.fontWeight = 'bold';
                                            errorLine.textContent = 'âŒ ' + data.message;
                                            logElement.appendChild(errorLine);
                                            
                                            showNotification(`âŒ æ„å»ºå¤±è´¥: ${projectName} - ${data.message}`);
                                            
                                            setTimeout(() => {
                                                closeModal();
                                                if (channelBtn) {
                                                    channelBtn.innerHTML = originalText;
                                                }
                                                reject(new Error(data.message));
                                            }, 10000);
                                        }
                                        
                                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                        logContainer.scrollTop = logContainer.scrollHeight;
                                        
                                    } catch (e) {
                                        console.error('Failed to parse SSE data:', e);
                                    }
                                }
                            }
                        }
                        
                    } catch (err) {
                        if (channelBtn) {
                            channelBtn.innerHTML = 'âŒ æ„å»ºå¤±è´¥';
                        }
                        
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
                        progressText.textContent = 'âŒ æ„å»ºå¤±è´¥';
                        progressText.style.color = '#ef4444';
                        
                        const errorLine = document.createElement('div');
                        errorLine.style.color = '#ff4444';
                        errorLine.style.fontWeight = 'bold';
                        errorLine.textContent = 'âŒ ' + err.message;
                        logElement.appendChild(errorLine);
                        
                        showNotification(`âŒ æ„å»ºå¤±è´¥: ${err.message}`);
                        
                        setTimeout(() => {
                            closeModal();
                            if (channelBtn) {
                                channelBtn.innerHTML = originalText;
                            }
                            reject(err);
                        }, 10000);
                    }
                })();
            });
        }

        // åŠ¨æ€åŠ è½½å¹¶æ¸²æŸ“æœ€è¿‘é¡¹ç›®ï¼ˆçœŸå®æ•°æ®ï¼‰
        function loadProjectStatuses() {
            const container = document.getElementById('recent-projects');
            if (!container) return;
            fetch('http://localhost:5178/api/projects')
                .then(r => r.json())
                .then(data => {
                    if (!data.projects) { container.innerHTML = '<div style="padding:20px;color:#999;">æ— é¡¹ç›®</div>'; return; }
                    window.PROJECT_PATHS = Object.fromEntries(data.projects.map(p => [p.name, p.path]));
                    const sorted = [...data.projects].sort((a,b)=> new Date(b.lastCommitTime) - new Date(a.lastCommitTime));
                    // åªæ˜¾ç¤ºæœ€è¿‘çš„6ä¸ªé¡¹ç›®
                    const recentProjects = sorted.slice(0, 6);
                    container.innerHTML = recentProjects.map(p => {
                        const relTime = p.lastCommitTime ? 'æœ€åæ›´æ–°: ' + formatRelativeTime(p.lastCommitTime) : 'æœ€åæ›´æ–°: æœªçŸ¥';
                        return `
                        <div class="work-item project-item" data-project="${p.name}">
                            <div class="time">ğŸ“</div>
                            <div class="desc">
                                <strong>${p.name}</strong><br>
                                <span class="project-time" data-time="${p.lastCommitTime || ''}">${relTime}</span>
                                <div class="project-status">
                                    <span class="status-badge modified" style="display:none;">
                                        <span>ğŸ“</span> <span class="modified-count">0</span> å·²ä¿®æ”¹
                                    </span>
                                    <span class="status-badge added" style="display:none;">
                                        <span>â•</span> <span class="added-count">0</span> å·²æ·»åŠ 
                                    </span>
                                    <span class="status-badge deleted" style="display:none;">
                                        <span>â–</span> <span class="deleted-count">0</span> å·²åˆ é™¤
                                    </span>
                                    <span class="status-badge clean" style="display:none;">
                                        <span>âœ…</span> æ— å˜åŒ–
                                    </span>
                                </div>
                            </div>
                            <div class="project-actions">
                                <button class="action-btn" onclick="backendPull('${p.name}')" title="åç«¯æ‹‰å– (git pull)"><span>â¬‡ï¸</span></button>
                                <button class="action-btn" onclick="backendPush('${p.name}')" title="åç«¯æ¨é€ (git add/commit/push)"><span>â¬†ï¸</span></button>
                                <button class="action-btn" onclick="showBuildOptions('${p.name}')" title="æ„å»ºé¡¹ç›®"><span>ğŸ”¨</span></button>
                                <button class="action-btn" onclick="showUploadOptions('${p.name}')" title="ä¸Šä¼ åˆ° OSS"><span>â˜ï¸</span></button>
                            </div>
                        </div>`;
                    }).join('');
                    // çŠ¶æ€è¯·æ±‚ - åªä¸ºæ˜¾ç¤ºçš„6ä¸ªé¡¹ç›®è·å–çŠ¶æ€
                    recentProjects.forEach(p => {
                        fetch(`http://localhost:5178/api/status?path=${encodeURIComponent(p.path)}`)
                            .then(r=>r.json())
                            .then(st => {
                                const el = container.querySelector(`[data-project="${p.name}"]`);
                                if (el) updateProjectStatus(el, st.modified||0, st.added||0, st.deleted||0);
                            })
                            .catch(()=>{});
                        
                        // åŠ è½½æ¸ é“é…ç½®
                        loadProjectChannels(p.name);
                    });
                })
                .catch(err => {
                    console.warn('æ— æ³•è·å–é¡¹ç›®æ•°æ®', err);
                    container.innerHTML = '<div style="padding:20px;color:#c00;">åŠ è½½é¡¹ç›®å¤±è´¥</div>';
                });
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        (function initProjects() {
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateProjectTimes();
            
            // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´
            setInterval(updateProjectTimes, 60000);

            // åŠ è½½GitçŠ¶æ€
            loadProjectStatuses();
            // æ¯60ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
            setInterval(loadProjectStatuses, 60000);
        })();

        function openAction(type) {
            // æ‰§è¡ŒçœŸå®çš„æ“ä½œ
            switch (type) {
                case 'ai':
                    // æ–°å»ºé¡¹ç›®
                    const projectName = prompt('è¯·è¾“å…¥æ–°é¡¹ç›®åç§°:');
                    if (projectName) {
                        createNewProject(projectName);
                    }
                    break;

                case 'ls':
                    // æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
                    showProjectList();
                    break;

                case 'env':
                    // ç¯å¢ƒæ£€æŸ¥
                    checkEnvironment();
                    break;

                case 'backup':
                    // å¤‡ä»½é¡¹ç›®
                    backupProjects();
                    break;

                case 'vscode':
                    // æ‰“å¼€ VS Codeï¼ˆåœ¨ Web ç¯å¢ƒä¸­æ‰“å¼€å½“å‰ä»“åº“ï¼‰
                    openInVSCode();
                    break;

                case 'terminal':
                    // æ˜¾ç¤ºç»ˆç«¯å‘½ä»¤
                    showTerminalCommands();
                    break;

                default:
                    showNotification('âš ï¸ æœªçŸ¥æ“ä½œ');
            }
        }

        // åˆ›å»ºæ–°é¡¹ç›®
        function createNewProject(name) {
            showNotification('ğŸš€ æ­£åœ¨åˆ›å»ºé¡¹ç›®: ' + name);

            // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIåˆ›å»ºé¡¹ç›®
            // ç›®å‰æ˜¾ç¤ºä¸€ä¸ªæ¨¡æ‹Ÿçš„åˆ›å»ºè¿‡ç¨‹
            setTimeout(() => {
                const projectUrl = `https://github.com/fengkuangdeshitou/${name}`;
                const message = `âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸï¼\n\né¡¹ç›®åç§°: ${name}\nå»ºè®®çš„ Git å‘½ä»¤:\n\nmkdir ~/Project/${name}\ncd ~/Project/${name}\ngit init\necho "# ${name}" > README.md\ngit add .\ngit commit -m "Initial commit"\ngit remote add origin ${projectUrl}.git\ngit push -u origin main`;

                if (confirm(message + '\n\næ˜¯å¦å¤åˆ¶å‘½ä»¤åˆ°å‰ªè´´æ¿ï¼Ÿ')) {
                    copyToClipboard(`mkdir ~/Project/${name}\ncd ~/Project/${name}\ngit init`);
                    showNotification('ğŸ“‹ å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }
            }, 500);
        }

        // æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
        function showProjectList() {
            showNotification('ğŸ“Š æ­£åœ¨è·å–é¡¹ç›®åˆ—è¡¨...');

            // è·å– GitHub ä»“åº“åˆ—è¡¨
            fetch('https://api.github.com/users/fengkuangdeshitou/repos?sort=updated&per_page=10')
                .then(response => response.json())
                .then(repos => {
                    let content = '<div style="max-height: 400px; overflow-y: auto;">';

                    repos.forEach((repo, index) => {
                        const updated = new Date(repo.updated_at).toLocaleDateString('zh-CN');
                        const updatedTime = new Date(repo.updated_at).toLocaleString('zh-CN');

                        content += `
                            <div class="env-check-item" style="cursor: pointer;" onclick="window.open('${repo.html_url}', '_blank')">
                                <div class="env-check-icon">${index + 1}</div>
                                <div class="env-check-content">
                                    <div class="env-check-label">${repo.name}</div>
                                    <div class="env-check-value">
                                        â­ ${repo.stargazers_count} | ğŸ”€ ${repo.forks_count} | ğŸ“… ${updated}
                                        ${repo.description ? '<br>' + repo.description : ''}
                                    </div>
                                </div>
                                <div class="env-check-status">ğŸ”—</div>
                            </div>
                        `;
                    });

                    content += '</div>';
                    content += `
                        <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 8px; text-align: center; color: #0066cc; font-size: 0.9em;">
                            ğŸ’¡ ç‚¹å‡»é¡¹ç›®å¡ç‰‡å¯ç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                        </div>
                    `;

                    showModal('ğŸ“ æœ€è¿‘æ›´æ–°çš„é¡¹ç›® (å‰10ä¸ª)', content);
                })
                .catch(error => {
                    console.error('è·å–é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                    const content = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">âŒ</div>
                            <div style="font-size: 1.2em; color: #dc3545; margin-bottom: 15px; font-weight: 600;">
                                è·å–é¡¹ç›®åˆ—è¡¨å¤±è´¥
                            </div>
                            <div style="color: #666; margin-bottom: 20px;">
                                æ— æ³•è¿æ¥åˆ° GitHub APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <div style="font-weight: 600; color: #856404; margin-bottom: 10px;">ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆ</div>
                                <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">
                                    åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æœ¬åœ°é¡¹ç›®ï¼š
                                </div>
                                <div class="command-box">
                                    <button class="copy-command-btn" onclick="copyToClipboard('cd ~/Project && ls -la'); event.stopPropagation();">å¤åˆ¶</button>
                                    <code>cd ~/Project && ls -la</code>
                                </div>
                            </div>
                        </div>
                    `;
                    showModal('ğŸ“Š é¡¹ç›®åˆ—è¡¨', content);
                });
        }

        // æ£€æŸ¥å¼€å‘ç¯å¢ƒ
        // æ£€æŸ¥å¼€å‘ç¯å¢ƒ
        function checkEnvironment() {
            showNotification('ğŸ”§ æ­£åœ¨æ£€æŸ¥å¼€å‘ç¯å¢ƒ...');

            // æ”¶é›†ç¯å¢ƒä¿¡æ¯
            const ua = navigator.userAgent;
            let browserName = 'Unknown';
            let browserVersion = '';

            if (ua.includes('Chrome/')) {
                browserName = 'Chrome';
                browserVersion = ua.match(/Chrome\/([\d.]+)/)?.[1] || '';
            } else if (ua.includes('Safari/') && !ua.includes('Chrome')) {
                browserName = 'Safari';
                browserVersion = ua.match(/Version\/([\d.]+)/)?.[1] || '';
            } else if (ua.includes('Firefox/')) {
                browserName = 'Firefox';
                browserVersion = ua.match(/Firefox\/([\d.]+)/)?.[1] || '';
            } else if (ua.includes('Edge/')) {
                browserName = 'Edge';
                browserVersion = ua.match(/Edge\/([\d.]+)/)?.[1] || '';
            }

            const platform = navigator.platform;
            let platformName = platform;
            if (platform.includes('Mac')) platformName = 'MacIntel (macOS)';
            else if (platform.includes('Win')) platformName = 'Windows';
            else if (platform.includes('Linux')) platformName = 'Linux';

            const checks = [
                {
                    icon: 'ğŸŒ',
                    label: 'Browser',
                    value: `${browserName}/${browserVersion}`,
                    status: 'âœ…'
                },
                {
                    icon: 'ğŸ’»',
                    label: 'Platform',
                    value: platformName,
                    status: 'âœ…'
                },
                {
                    icon: 'ğŸŒ',
                    label: 'Language',
                    value: navigator.language,
                    status: 'âœ…'
                },
                {
                    icon: 'ğŸ“¡',
                    label: 'Online',
                    value: navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿',
                    status: navigator.onLine ? 'âœ…' : 'âŒ'
                },
                {
                    icon: 'ğŸª',
                    label: 'Cookies',
                    value: navigator.cookieEnabled ? 'å¯ç”¨' : 'ç¦ç”¨',
                    status: navigator.cookieEnabled ? 'âœ…' : 'âŒ'
                },
                {
                    icon: 'ğŸ’¾',
                    label: 'LocalStorage',
                    value: typeof (Storage) !== 'undefined' ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ',
                    status: typeof (Storage) !== 'undefined' ? 'âœ…' : 'âŒ'
                }
            ];

            // æ„å»ºå¼¹æ¡†å†…å®¹
            let content = '';
            checks.forEach(check => {
                content += `
                    <div class="env-check-item">
                        <div class="env-check-icon">${check.icon}</div>
                        <div class="env-check-content">
                            <div class="env-check-label">${check.label}</div>
                            <div class="env-check-value">${check.value}</div>
                        </div>
                        <div class="env-check-status">${check.status}</div>
                    </div>
                `;
            });

            // æ·»åŠ ç»ˆç«¯å‘½ä»¤æç¤º
            const commands = `which node && node --version
which python3 && python3 --version
which git && git --version`;

            content += `
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <div style="font-weight: 600; color: #856404; margin-bottom: 10px;">ğŸ’¡ å®Œæ•´ç¯å¢ƒæ£€æŸ¥</div>
                    <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">
                        åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æ£€æŸ¥å¼€å‘å·¥å…·ï¼š
                    </div>
                    <div class="command-box">
                        <button class="copy-command-btn" onclick="copyToClipboard(\`${commands}\`); event.stopPropagation();">å¤åˆ¶</button>
                        <code>${commands}</code>
                    </div>
                </div>
            `;

            showModal('ğŸ” æµè§ˆå™¨ç¯å¢ƒæ£€æŸ¥', content);
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹æ¡†
        function showModal(title, content, footerButtons = null) {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');

            modalTitle.innerHTML = title;
            modalBody.innerHTML = content;

            // å¦‚æœæä¾›äº†è‡ªå®šä¹‰æŒ‰é’®ï¼Œæ›´æ–° footer
            if (footerButtons) {
                modalFooter.innerHTML = footerButtons;
            } else {
                modalFooter.innerHTML = `
                    <span class="modal-footer-text">AI ç§äººåŠ©ç† v1.6.0</span>
                    <button class="modal-button" onclick="closeModal()">ç¡®å®š</button>
                `;
            }

            modal.classList.add('active');

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = function (e) {
                if (e.target === modal) {
                    closeModal();
                }
            };

            // ESC é”®å…³é—­
            document.onkeydown = function (e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeModal();
                }
            };
        }

        // å¤‡ä»½é¡¹ç›®
        function backupProjects() {
            showNotification('ğŸ’¾ å‡†å¤‡å¤‡ä»½é¡¹ç›®...');

            const backupTime = new Date().toISOString().replace(/[:.]/g, '-');
            const message = `ğŸ’¾ é¡¹ç›®å¤‡ä»½æŒ‡å—\n\nå»ºè®®åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:\n\n1. åˆ›å»ºå¤‡ä»½ç›®å½•:\nmkdir -p ~/Backups/${backupTime}\n\n2. å¤‡ä»½æ‰€æœ‰é¡¹ç›®:\ncp -r ~/Project/* ~/Backups/${backupTime}/\n\n3. å‹ç¼©å¤‡ä»½:\ncd ~/Backups\ntar -czf backup-${backupTime}.tar.gz ${backupTime}\n\n4. éªŒè¯å¤‡ä»½:\nls -lh backup-${backupTime}.tar.gz\n\næ˜¯å¦å¤åˆ¶å‘½ä»¤åˆ°å‰ªè´´æ¿ï¼Ÿ`;

            if (confirm(message)) {
                const commands = `mkdir -p ~/Backups/${backupTime}\ncp -r ~/Project/* ~/Backups/${backupTime}/\ncd ~/Backups\ntar -czf backup-${backupTime}.tar.gz ${backupTime}`;
                copyToClipboard(commands);
                showNotification('ğŸ“‹ å¤‡ä»½å‘½ä»¤å·²å¤åˆ¶');
            }
        }

        // åœ¨ VS Code ä¸­æ‰“å¼€
        function openInVSCode() {
            const repoUrl = 'https://github.com/fengkuangdeshitou/ai-personal-assistant';
            const vscodeUrl = `vscode://vscode.git/clone?url=${encodeURIComponent(repoUrl)}`;

            showNotification('ğŸ’» æ­£åœ¨æ‰“å¼€ VS Code...');

            // å°è¯•æ‰“å¼€ VS Code
            window.location.href = vscodeUrl;

            setTimeout(() => {
                const message = `ğŸ’» VS Code æ‰“å¼€æ–¹å¼:\n\n1. é€šè¿‡ URL Scheme:\n${vscodeUrl}\n\n2. åœ¨ç»ˆç«¯ä¸­:\ncode ~/Project/ai-personal-assistant\n\n3. åœ¨ GitHub ä¸ŠæŒ‰ . é”®:\n${repoUrl}\n\n4. ä½¿ç”¨ GitHub.dev:\nhttps://github.dev/fengkuangdeshitou/ai-personal-assistant`;
                alert(message);
            }, 1000);
        }

        // æ˜¾ç¤ºç»ˆç«¯å‘½ä»¤
        function showTerminalCommands() {
            const commands = `ğŸ–¥ï¸ å¸¸ç”¨ç»ˆç«¯å‘½ä»¤:\n\nã€é¡¹ç›®ç®¡ç†ã€‘\ncd ~/Project              # è¿›å…¥é¡¹ç›®ç›®å½•\nls -la                    # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶\npwd                       # æ˜¾ç¤ºå½“å‰è·¯å¾„\n\nã€Git æ“ä½œã€‘\ngit status                # æŸ¥çœ‹çŠ¶æ€\ngit log --oneline -10     # æŸ¥çœ‹æœ€è¿‘10æ¬¡æäº¤\ngit diff --stat           # æŸ¥çœ‹ä¿®æ”¹ç»Ÿè®¡\n\nã€å¼€å‘å·¥å…·ã€‘\ncode .                    # ç”¨ VS Code æ‰“å¼€\nnpm start                 # å¯åŠ¨é¡¹ç›®\npython3 -m http.server    # å¯åŠ¨ç®€å•æœåŠ¡å™¨\n\nã€ç³»ç»Ÿä¿¡æ¯ã€‘\nnode --version            # Node.js ç‰ˆæœ¬\npython3 --version         # Python ç‰ˆæœ¬\ngit --version             # Git ç‰ˆæœ¬\n\næ˜¯å¦å¤åˆ¶è¿™äº›å‘½ä»¤ï¼Ÿ`;

            if (confirm(commands)) {
                copyToClipboard('cd ~/Project\nls -la\ngit status\ncode .');
                showNotification('ğŸ“‹ å‘½ä»¤å·²å¤åˆ¶');
            }
        }

        // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            }
            document.body.removeChild(textArea);
        }

        // æ—¶é—´æé†’åŠŸèƒ½
        function checkTimeReminders() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const timeKey = `${currentHour}:${currentMinute}`;
            
            // é¿å…é‡å¤æé†’ï¼ˆä½¿ç”¨ sessionStorage è®°å½•å·²æé†’çš„æ—¶é—´ï¼‰
            const remindedToday = sessionStorage.getItem('reminded_' + timeKey);
            if (remindedToday) return;
            
            let message = '';
            let emoji = '';
            
            // å®šä¹‰æé†’æ—¶é—´ç‚¹
            if (currentHour === 12 && currentMinute === 30) {
                emoji = 'ğŸ±';
                message = 'åˆä¼‘æ—¶é—´åˆ°äº†ï¼è®°å¾—ä¼‘æ¯ä¸€ä¸‹~';
            } else if (currentHour === 14 && currentMinute === 0) {
                emoji = 'ğŸ’¼';
                message = 'ä¸‹åˆå·¥ä½œå¼€å§‹å•¦ï¼ç»§ç»­åŠ æ²¹ï¼';
            } else if (currentHour === 18 && currentMinute === 30) {
                emoji = 'ğŸ‰';
                message = 'ä¸‹ç­æ—¶é—´åˆ°ï¼è¾›è‹¦äº†ä¸€å¤©ï¼Œè¯¥ä¼‘æ¯äº†~';
            } else if (currentHour === 9 && currentMinute === 30) {
                emoji = 'â˜•';
                message = 'æ—©å®‰ï¼æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼Œå…ˆæ¥æ¯å’–å•¡å§~';
            }
            
            if (message) {
                // æ˜¾ç¤ºé€šçŸ¥
                showNotification(emoji + ' ' + message);
                
                // è®°å½•å·²æé†’ï¼ˆé¿å…é‡å¤ï¼‰
                sessionStorage.setItem('reminded_' + timeKey, 'true');
                
                // 1å°æ—¶åæ¸…é™¤è®°å½•ï¼ˆé˜²æ­¢ sessionStorage ç´¯ç§¯è¿‡å¤šæ•°æ®ï¼‰
                setTimeout(() => {
                    sessionStorage.removeItem('reminded_' + timeKey);
                }, 3600000);
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        updateGreeting();
        setInterval(updateGreeting, 60000);
        
        // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ—¶é—´æé†’
        checkTimeReminders();
        setInterval(checkTimeReminders, 60000);

        // é¡µé¢åŠ è½½æ—¶è·å–ä¸€æ¬¡çœŸå®æ•°æ®
        loadStats();
        loadWorkTimeline();
        updateWeeklyChart(); // åŠ è½½æœ¬å‘¨è¶‹åŠ¿æ•°æ®
        loadSystemInfo();
        loadUserSettings();

        // ==================== è®¾ç½®ç®¡ç†åŠŸèƒ½ ====================

        // åŠ è½½ç”¨æˆ·è®¾ç½®
        function loadUserSettings() {
            const settings = getSettings();

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            if (document.getElementById('userName')) {
                document.getElementById('userName').textContent = settings.userName;
            }
            if (document.getElementById('autoRefreshStatus')) {
                document.getElementById('autoRefreshStatus').textContent = settings.autoRefresh ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
            }
            if (document.getElementById('refreshInterval')) {
                document.getElementById('refreshInterval').textContent = settings.refreshInterval;
            }
            if (document.getElementById('workStartTime')) {
                document.getElementById('workStartTime').textContent = settings.workStartTime;
            }
            if (document.getElementById('workEndTime')) {
                document.getElementById('workEndTime').textContent = settings.workEndTime;
            }
            if (document.getElementById('githubUser')) {
                document.getElementById('githubUser').textContent = settings.githubUser;
            }
            if (document.getElementById('githubRepo')) {
                document.getElementById('githubRepo').textContent = settings.githubRepo;
            }

            // æ›´æ–° AI é…ç½®æ˜¾ç¤º
            updateAIDisplay(settings);

            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            if (settings.autoRefresh) {
                setInterval(() => {
                    loadStats();
                    loadWorkTimeline();
                    updateWeeklyChart(); // è‡ªåŠ¨åˆ·æ–°æ—¶ä¹Ÿæ›´æ–°æœ¬å‘¨è¶‹åŠ¿
                }, settings.refreshInterval * 60 * 1000);
            }
        }

        // è·å–è®¾ç½®
        function getSettings() {
            const defaultSettings = {
                userName: 'ç–¯ç‹‚çš„çŸ³å¤´',
                autoRefresh: true,
                refreshInterval: 30,
                workStartTime: '09:30',
                workEndTime: '18:30',
                lunchStartTime: '12:30',
                lunchEndTime: '14:00',
                githubUser: 'fengkuangdeshitou',
                githubRepo: 'ai-personal-assistant',
                githubToken: '',
                // AI å¯¹è¯é…ç½®
                aiProvider: '', // 'openai', 'claude', 'gemini', 'local' æˆ–ç•™ç©ºä½¿ç”¨å†…ç½®
                aiApiKey: '',
                aiModel: '', // æ¨¡å‹åç§°
                aiEndpoint: 'http://localhost:11434/api/generate' // æœ¬åœ° AI ç«¯ç‚¹
            };

            const saved = localStorage.getItem('AI_ASSISTANT_SETTINGS');
            if (saved) {
                try {
                    return { ...defaultSettings, ...JSON.parse(saved) };
                } catch (e) {
                    console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e);
                    return defaultSettings;
                }
            }
            return defaultSettings;
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings(settings) {
            localStorage.setItem('AI_ASSISTANT_SETTINGS', JSON.stringify(settings));
            showNotification('âœ… è®¾ç½®å·²ä¿å­˜');
        }

        // ä¿®æ”¹ç”¨æˆ·å
        function editUserName() {
            const settings = getSettings();
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç§°å‘¼:', settings.userName);
            if (newName && newName.trim()) {
                settings.userName = newName.trim();
                saveSettings(settings);
                document.getElementById('userName').textContent = settings.userName;
                updateGreeting();
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const settings = getSettings();

            if (settings.autoRefresh) {
                // å½“å‰æ˜¯å¯ç”¨çŠ¶æ€ï¼Œè¯¢é—®æ˜¯å¦ç¦ç”¨
                if (confirm('ç¡®å®šè¦ç¦ç”¨è‡ªåŠ¨åˆ·æ–°å—ï¼Ÿ\n\nç¦ç”¨åéœ€è¦æ‰‹åŠ¨ç‚¹å‡»åˆ·æ–°æŒ‰é’®æ›´æ–°æ•°æ®ã€‚')) {
                    settings.autoRefresh = false;
                    saveSettings(settings);
                    document.getElementById('autoRefreshStatus').textContent = 'å·²ç¦ç”¨';
                    showNotification('ğŸ”• è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
                }
            } else {
                // å½“å‰æ˜¯ç¦ç”¨çŠ¶æ€ï¼Œè¯¢é—®åˆ·æ–°é—´éš”
                const interval = prompt('è¯·è®¾ç½®è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰:', settings.refreshInterval);
                if (interval && !isNaN(interval) && interval > 0) {
                    settings.autoRefresh = true;
                    settings.refreshInterval = parseInt(interval);
                    saveSettings(settings);
                    document.getElementById('autoRefreshStatus').textContent = 'å·²å¯ç”¨';
                    document.getElementById('refreshInterval').textContent = settings.refreshInterval;
                    showNotification('ğŸ”” è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨');
                    location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°è®¾ç½®
                }
            }
        }

        // ä¿®æ”¹å·¥ä½œæ—¶é—´
        function editWorkTime() {
            const settings = getSettings();
            const message = `å½“å‰å·¥ä½œæ—¶é—´è®¾ç½®ï¼š\nä¸Šç­: ${settings.workStartTime}\nä¸‹ç­: ${settings.workEndTime}\nåˆä¼‘: ${settings.lunchStartTime}-${settings.lunchEndTime}\n\næ˜¯å¦è¦ä¿®æ”¹ï¼Ÿ`;

            if (confirm(message)) {
                const startTime = prompt('è¯·è¾“å…¥ä¸Šç­æ—¶é—´ (ä¾‹å¦‚: 09:30):', settings.workStartTime);
                if (!startTime) return;

                const endTime = prompt('è¯·è¾“å…¥ä¸‹ç­æ—¶é—´ (ä¾‹å¦‚: 18:30):', settings.workEndTime);
                if (!endTime) return;

                // éªŒè¯æ—¶é—´æ ¼å¼
                const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
                if (!timeRegex.test(startTime) || !timeRegex.test(endTime)) {
                    alert('æ—¶é—´æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨ HH:MM æ ¼å¼ï¼ˆä¾‹å¦‚: 09:30ï¼‰');
                    return;
                }

                settings.workStartTime = startTime;
                settings.workEndTime = endTime;
                saveSettings(settings);

                document.getElementById('workStartTime').textContent = startTime;
                document.getElementById('workEndTime').textContent = endTime;

                showNotification('âœ… å·¥ä½œæ—¶é—´å·²æ›´æ–°');
            }
        }

        // ä¿®æ”¹ GitHub é…ç½®
        function editGitHubConfig() {
            const settings = getSettings();
            const message = `å½“å‰ GitHub é…ç½®ï¼š\nç”¨æˆ·: ${settings.githubUser}\nä»“åº“: ${settings.githubRepo}\n\næ˜¯å¦è¦ä¿®æ”¹ï¼Ÿ`;

            if (confirm(message)) {
                const user = prompt('è¯·è¾“å…¥ GitHub ç”¨æˆ·å:', settings.githubUser);
                if (!user) return;

                const repo = prompt('è¯·è¾“å…¥ä»“åº“åç§°:', settings.githubRepo);
                if (!repo) return;

                const token = prompt('è¯·è¾“å…¥ GitHub Token (å¯é€‰ï¼Œç•™ç©ºè·³è¿‡):\n\nç”¨äºæé«˜ API è¯·æ±‚é™åˆ¶', settings.githubToken);

                settings.githubUser = user;
                settings.githubRepo = repo;
                if (token) settings.githubToken = token;

                saveSettings(settings);

                document.getElementById('githubUser').textContent = user;
                document.getElementById('githubRepo').textContent = repo;

                showNotification('âœ… GitHub é…ç½®å·²æ›´æ–°\nåˆ·æ–°æ•°æ®ä»¥åº”ç”¨æ–°é…ç½®');
            }
        }

        // é…ç½® AI å¯¹è¯
        function editAIConfig() {
            const settings = getSettings();

            const content = `
                <div style="text-align: left; padding: 20px;">
                    <h3 style="margin-top: 0;">ğŸ¤– AI å¯¹è¯é…ç½®</h3>
                    <p style="color: #666; font-size: 0.9em;">é…ç½®çœŸå® AI API ä»¥è·å¾—æ›´æ™ºèƒ½çš„å¯¹è¯ä½“éªŒ</p>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">AI æœåŠ¡å•†:</label>
                        <select id="aiProviderSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">å†…ç½®è§„åˆ™ï¼ˆé»˜è®¤ï¼‰</option>
                            <option value="openai">OpenAI (GPT) ğŸ’°</option>
                            <option value="claude">Claude (Anthropic) ğŸ’°</option>
                            <option value="gemini">Google Gemini â­</option>
                            <option value="local">æœ¬åœ° AI (Ollama) ğŸ”’</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ğŸ’¡ æç¤ºï¼šGitHub Copilot ä»…èƒ½é€šè¿‡ VS Code æ’ä»¶ä½¿ç”¨ï¼Œæ¨èä½¿ç”¨ OpenAI API
                        </small>
                    </div>
                    
                    <div id="apiKeySection" style="margin: 20px 0; display: none;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">API Key:</label>
                        <input type="password" id="aiApiKeyInput" placeholder="è¾“å…¥æ‚¨çš„ API Key" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #999;">æ‚¨çš„ API Key ä»…ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ </small>
                    </div>
                    
                    <div id="modelSection" style="margin: 20px 0; display: none;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ¨¡å‹:</label>
                        <input type="text" id="aiModelInput" placeholder="ä¾‹å¦‚: gpt-3.5-turbo" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div id="endpointSection" style="margin: 20px 0; display: none;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">API ç«¯ç‚¹:</label>
                        <input type="text" id="aiEndpointInput" value="http://localhost:11434/api/generate" 
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #f0f7ff; border-radius: 4px; border-left: 3px solid #667eea;">
                        <strong>ğŸ’¡ å¿«é€Ÿå…¥é—¨:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px; font-size: 0.9em;">
                            <li><strong>OpenAI:</strong> è·å– API Key: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a> (æ¨è)</li>
                            <li><strong>Claude:</strong> è·å– API Key: <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></li>
                            <li><strong>Gemini:</strong> è·å– API Key: <a href="https://makersuite.google.com/app/apikey" target="_blank">makersuite.google.com</a> (å…è´¹)</li>
                            <li><strong>æœ¬åœ° AI:</strong> å®‰è£… Ollama: <a href="https://ollama.ai" target="_blank">ollama.ai</a> (å®Œå…¨ç§å¯†)</li>
                        </ul>
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px;">
                            <strong>âš ï¸ å…³äº GitHub Copilot:</strong><br>
                            <small>GitHub Copilot ä»…æ”¯æŒé€šè¿‡ VS Code/IDE æ’ä»¶ä½¿ç”¨ï¼Œä¸æä¾›ç‹¬ç«‹çš„ HTTP APIã€‚<br>
                            å¦‚æœæ‚¨æƒ³è¦ç±»ä¼¼çš„ AI èƒ½åŠ›ï¼Œæ¨èä½¿ç”¨ <strong>OpenAI GPT-3.5/4</strong>ï¼ˆCopilot åº•å±‚ä¹Ÿä½¿ç”¨ OpenAIï¼‰ã€‚</small>
                        </div>
                    </div>
                </div>
            `;

            const footer = `
                <button onclick="closeModal()" style="padding: 10px 20px; margin-right: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button onclick="saveAIConfig()" style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 4px; cursor: pointer;">ä¿å­˜é…ç½®</button>
            `;

            showModal('ğŸ¤– AI å¯¹è¯é…ç½®', content, footer);

            // è®¾ç½®å½“å‰å€¼
            document.getElementById('aiProviderSelect').value = settings.aiProvider || '';
            document.getElementById('aiApiKeyInput').value = settings.aiApiKey || '';
            document.getElementById('aiModelInput').value = settings.aiModel || '';
            document.getElementById('aiEndpointInput').value = settings.aiEndpoint || 'http://localhost:11434/api/generate';

            // ç›‘å¬æœåŠ¡å•†å˜åŒ–
            document.getElementById('aiProviderSelect').addEventListener('change', function () {
                const provider = this.value;
                const apiKeySection = document.getElementById('apiKeySection');
                const modelSection = document.getElementById('modelSection');
                const endpointSection = document.getElementById('endpointSection');

                if (provider === '') {
                    apiKeySection.style.display = 'none';
                    modelSection.style.display = 'none';
                    endpointSection.style.display = 'none';
                } else if (provider === 'local') {
                    apiKeySection.style.display = 'none';
                    modelSection.style.display = 'block';
                    endpointSection.style.display = 'block';
                    document.getElementById('aiModelInput').placeholder = 'ä¾‹å¦‚: llama2, codellama';
                } else {
                    apiKeySection.style.display = 'block';
                    modelSection.style.display = 'block';
                    endpointSection.style.display = 'none';
                    document.getElementById('aiApiKeyInput').type = 'password';

                    if (provider === 'openai') {
                        document.getElementById('aiModelInput').placeholder = 'ä¾‹å¦‚: gpt-3.5-turbo, gpt-4';
                    } else if (provider === 'claude') {
                        document.getElementById('aiModelInput').placeholder = 'ä¾‹å¦‚: claude-3-haiku-20240307';
                    } else if (provider === 'gemini') {
                        document.getElementById('aiModelInput').placeholder = 'ä¾‹å¦‚: gemini-pro';
                    }
                }
            });

            // è§¦å‘ä¸€æ¬¡å˜åŒ–äº‹ä»¶ä»¥æ˜¾ç¤ºæ­£ç¡®çš„è¾“å…¥æ¡†
            document.getElementById('aiProviderSelect').dispatchEvent(new Event('change'));
        }

        // ä¿å­˜ AI é…ç½®
        function saveAIConfig() {
            const settings = getSettings();
            const provider = document.getElementById('aiProviderSelect').value;
            const apiKey = document.getElementById('aiApiKeyInput').value;
            const model = document.getElementById('aiModelInput').value;
            const endpoint = document.getElementById('aiEndpointInput').value;

            settings.aiProvider = provider;
            settings.aiApiKey = apiKey;
            settings.aiModel = model;
            settings.aiEndpoint = endpoint;

            saveSettings(settings);
            updateAIDisplay(settings);
            closeModal();

            if (provider) {
                showNotification('âœ… AI é…ç½®å·²ä¿å­˜\nç°åœ¨å¯ä»¥ä½¿ç”¨çœŸå® AI å¯¹è¯äº†ï¼');
            } else {
                showNotification('âœ… å·²åˆ‡æ¢åˆ°å†…ç½®è§„åˆ™æ¨¡å¼');
            }
        }

        // æ›´æ–° AI æ˜¾ç¤º
        function updateAIDisplay(settings) {
            const providerDisplay = document.getElementById('aiProviderDisplay');
            const statusDisplay = document.getElementById('aiStatusDisplay');

            if (!settings.aiProvider) {
                providerDisplay.textContent = 'å†…ç½®è§„åˆ™';
                statusDisplay.textContent = 'ä½¿ç”¨å†…ç½®å›å¤';
            } else {
                const providerNames = {
                    'openai': 'OpenAI GPT ğŸ’°',
                    'claude': 'Claude (Anthropic) ğŸ’°',
                    'gemini': 'Google Gemini â­',
                    'local': 'æœ¬åœ° AI ğŸ”’'
                };
                providerDisplay.textContent = providerNames[settings.aiProvider] || settings.aiProvider;
                statusDisplay.textContent = settings.aiApiKey || settings.aiProvider === 'local' ? 'å·²é…ç½®' : 'æœªé…ç½® API Key';
            }
        }

        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        function loadSystemInfo() {
            // ç‰ˆæœ¬ä¿¡æ¯
            document.getElementById('appVersion').textContent = 'v1.6.0';

            // å¹³å°ä¿¡æ¯
            const platform = navigator.platform || 'Unknown';
            let platformName = platform;
            if (platform.includes('Mac')) platformName = 'macOS';
            else if (platform.includes('Win')) platformName = 'Windows';
            else if (platform.includes('Linux')) platformName = 'Linux';
            document.getElementById('systemPlatform').textContent = platformName;

            // æµè§ˆå™¨ä¿¡æ¯
            const ua = navigator.userAgent;
            let browserName = 'Unknown';
            if (ua.includes('Chrome')) browserName = 'Chrome';
            else if (ua.includes('Safari')) browserName = 'Safari';
            else if (ua.includes('Firefox')) browserName = 'Firefox';
            else if (ua.includes('Edge')) browserName = 'Edge';
            document.getElementById('browserInfo').textContent = browserName;

            // è·å–æœ€åæ›´æ–°æ—¶é—´ï¼ˆä» GitHubï¼‰
            fetchLastUpdateDate();

            // æ£€æŸ¥åŒæ­¥çŠ¶æ€
            checkSyncStatus();

            // è®¡ç®—ç¼“å­˜å¤§å°
            calculateCacheSize();
        }

        // è·å–æœ€åæ›´æ–°æ—¶é—´
        async function fetchLastUpdateDate() {
            const settings = getSettings();
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${settings.githubUser}/${settings.githubRepo}/commits?per_page=1`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.ok) {
                    const commits = await response.json();
                    if (commits.length > 0) {
                        const lastCommitDate = new Date(commits[0].commit.author.date);
                        const dateStr = lastCommitDate.toLocaleDateString('zh-CN');
                        document.getElementById('lastUpdateDate').textContent = dateStr;
                        return;
                    }
                }
            } catch (error) {
                console.error('è·å–æ›´æ–°æ—¶é—´å¤±è´¥:', error);
            }

            document.getElementById('lastUpdateDate').textContent = 'æœªçŸ¥';
        }

        // æ£€æŸ¥åŒæ­¥çŠ¶æ€
        async function checkSyncStatus() {
            try {
                const response = await fetch('https://api.github.com/');
                if (response.ok) {
                    document.getElementById('syncStatus').textContent = 'âœ… æ­£å¸¸';
                } else {
                    document.getElementById('syncStatus').textContent = 'âš ï¸ å¼‚å¸¸';
                }
            } catch (error) {
                document.getElementById('syncStatus').textContent = 'âŒ ç¦»çº¿';
            }
        }

        // è®¡ç®—ç¼“å­˜å¤§å°
        function calculateCacheSize() {
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length + key.length;
                }
            }

            // è½¬æ¢ä¸º KB
            const sizeInKB = (totalSize / 1024).toFixed(2);
            document.getElementById('cacheSize').textContent = sizeInKB + ' KB';
        }

        // æ‰“å¼€ GitHub ä»“åº“
        function openGitHub() {
            const settings = getSettings();
            const url = `https://github.com/${settings.githubUser}/${settings.githubRepo}`;
            window.open(url, '_blank');
            showNotification('ğŸ”— æ­£åœ¨æ‰“å¼€ GitHub ä»“åº“...');
        }

        // æ£€æŸ¥æ›´æ–°
        async function checkForUpdates() {
            showNotification('ğŸ” æ­£åœ¨æ£€æŸ¥æ›´æ–°...');

            const settings = getSettings();
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${settings.githubUser}/${settings.githubRepo}/releases/latest`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.ok) {
                    const release = await response.json();
                    const latestVersion = release.tag_name;
                    const currentVersion = 'v1.6.0';
                    const publishDate = new Date(release.published_at).toLocaleDateString('zh-CN');

                    if (latestVersion === currentVersion) {
                        const content = `
                            <div style="text-align: center; padding: 30px 20px;">
                                <div style="font-size: 5em; margin-bottom: 20px;">âœ…</div>
                                <h3 style="color: #28a745; font-size: 1.5em; margin-bottom: 15px;">å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼</h3>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0;">
                                    <div style="display: grid; gap: 15px;">
                                        <div>
                                            <div style="color: #999; font-size: 0.9em;">å½“å‰ç‰ˆæœ¬</div>
                                            <div style="color: #667eea; font-size: 1.3em; font-weight: 600;">${currentVersion}</div>
                                        </div>
                                        <div>
                                            <div style="color: #999; font-size: 0.9em;">æœ€æ–°ç‰ˆæœ¬</div>
                                            <div style="color: #28a745; font-size: 1.3em; font-weight: 600;">${latestVersion}</div>
                                        </div>
                                        <div>
                                            <div style="color: #999; font-size: 0.9em;">å‘å¸ƒæ—¶é—´</div>
                                            <div style="color: #555; font-size: 1.1em; font-weight: 600;">${publishDate}</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="color: #666; font-size: 0.95em;">
                                    ğŸ‰ æ‚¨æ­£åœ¨ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼Œäº«å—æ‰€æœ‰æœ€æ–°åŠŸèƒ½ï¼
                                </div>
                            </div>
                        `;
                        showModal('ğŸ”„ ç‰ˆæœ¬æ£€æŸ¥', content);
                    } else {
                        const content = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 5em; margin-bottom: 15px;">ğŸ‰</div>
                                <h3 style="color: #667eea; font-size: 1.5em; margin-bottom: 20px;">å‘ç°æ–°ç‰ˆæœ¬ï¼</h3>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                        <div style="color: #999; font-size: 0.85em; margin-bottom: 5px;">å½“å‰ç‰ˆæœ¬</div>
                                        <div style="color: #dc3545; font-size: 1.3em; font-weight: 600;">${currentVersion}</div>
                                    </div>
                                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                                        <div style="color: #155724; font-size: 0.85em; margin-bottom: 5px;">æœ€æ–°ç‰ˆæœ¬</div>
                                        <div style="color: #28a745; font-size: 1.3em; font-weight: 600;">${latestVersion}</div>
                                    </div>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 1.1em;">ğŸ“ æ›´æ–°å†…å®¹</h4>
                                    <div style="color: #555; line-height: 1.6; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">
${release.body || 'â€¢ æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤\nâ€¢ æŸ¥çœ‹ GitHub Release äº†è§£è¯¦æƒ…'}
                                    </div>
                                </div>
                                
                                <button class="modal-button" onclick="window.open('${release.html_url}', '_blank'); closeModal();" 
                                        style="width: 100%; padding: 15px; font-size: 1.1em;">
                                    ğŸš€ å‰å¾€ä¸‹è½½
                                </button>
                            </div>
                        `;
                        showModal('ğŸ‰ æ›´æ–°å¯ç”¨', content);
                    }
                } else {
                    throw new Error('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
                const content = `
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">âŒ</div>
                        <h3 style="color: #dc3545; font-size: 1.3em; margin-bottom: 15px;">æ£€æŸ¥æ›´æ–°å¤±è´¥</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
                            <div style="color: #999; font-size: 0.9em; margin-bottom: 5px;">å½“å‰ç‰ˆæœ¬</div>
                            <div style="color: #667eea; font-size: 1.5em; font-weight: 600;">v1.6.0</div>
                        </div>
                        <div style="color: #666; margin-bottom: 20px;">
                            æ— æ³•è¿æ¥åˆ° GitHub API<br>
                            è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•
                        </div>
                        <button class="modal-button" onclick="window.open('https://github.com/${settings.githubUser}/${settings.githubRepo}/releases', '_blank'); closeModal();" 
                                style="width: 100%;">
                            ğŸ“¦ è®¿é—® GitHub Releases
                        </button>
                    </div>
                `;
                showModal('âš ï¸ æ£€æŸ¥æ›´æ–°', content);
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            showNotification('ğŸ“¤ æ­£åœ¨å‡†å¤‡å¯¼å‡ºæ•°æ®...');

            const data = {
                version: '1.6.0',
                exportDate: new Date().toISOString(),
                settings: getSettings(),
                stats: {
                    commits: document.getElementById('commits')?.textContent,
                    insertions: document.getElementById('insertions')?.textContent,
                    deletions: document.getElementById('deletions')?.textContent,
                    workHours: document.getElementById('work-hours')?.textContent
                },
                cache: {
                    gitStats: localStorage.getItem('gitStats'),
                    todayCommits: localStorage.getItem('todayCommits')
                }
            };

            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-assistant-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }

        // æ¸…é™¤ç¼“å­˜
        function clearCache() {
            const message = 'âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤ï¼š\nâ€¢ Git ç»Ÿè®¡ç¼“å­˜\nâ€¢ æäº¤è®°å½•ç¼“å­˜\nâ€¢ å…¶ä»–ä¸´æ—¶æ•°æ®\n\nç”¨æˆ·è®¾ç½®å°†ä¿ç•™';

            if (confirm(message)) {
                // ä¿å­˜è®¾ç½®
                const settings = getSettings();

                // æ¸…é™¤ç‰¹å®šçš„ç¼“å­˜é¡¹
                localStorage.removeItem('gitStats');
                localStorage.removeItem('gitStatsTime');
                localStorage.removeItem('todayCommits');

                // æ¢å¤è®¾ç½®
                saveSettings(settings);

                // é‡æ–°è®¡ç®—ç¼“å­˜å¤§å°
                calculateCacheSize();

                showNotification('âœ… ç¼“å­˜å·²æ¸…é™¤ï¼');
            }
        }

        // é‡ç½®è®¾ç½®
        function resetSettings() {
            const message = 'âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿ\n\nè¿™å°†ï¼š\nâ€¢ æ¢å¤é»˜è®¤é…ç½®\nâ€¢ æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®\nâ€¢ ä¿ç•™ç¼“å­˜æ•°æ®\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼';

            if (confirm(message)) {
                localStorage.removeItem('AI_ASSISTANT_SETTINGS');
                showNotification('âœ… è®¾ç½®å·²é‡ç½®ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...');
                setTimeout(() => location.reload(), 1000);
            }
        }

        // æ˜¾ç¤ºå…³äºä¿¡æ¯
        function showAbout() {
            const settings = getSettings();
            const content = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4em; margin-bottom: 15px;">ğŸ¤–</div>
                    <h3 style="font-size: 1.8em; color: #667eea; margin-bottom: 5px;">AI ç§äººåŠ©ç†</h3>
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 25px;">Your Intelligent Development Partner</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="color: #667eea; font-size: 1.2em; font-weight: 600;">v1.6.0</div>
                        <div style="color: #999; font-size: 0.85em; margin-top: 5px;">å½“å‰ç‰ˆæœ¬</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="color: #667eea; font-size: 1.2em; font-weight: 600;">${settings.githubUser}</div>
                        <div style="color: #999; font-size: 0.85em; margin-top: 5px;">å¼€å‘è€…</div>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea20, #764ba220); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px; font-size: 1.1em;">âœ¨ ä¸»è¦åŠŸèƒ½</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">ğŸ“Š</span>
                            <span style="color: #555;">å®æ—¶ Git ç»Ÿè®¡</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">ğŸ’¼</span>
                            <span style="color: #555;">å·¥ä½œè®°å½•è¿½è¸ª</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">ğŸš€</span>
                            <span style="color: #555;">å¿«é€Ÿå¼€å‘å·¥å…·</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">ğŸ’¬</span>
                            <span style="color: #555;">æ™ºèƒ½ AI å¯¹è¯</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.3em;">âš™ï¸</span>
                            <span style="color: #555;">çµæ´»é…ç½®ç®¡ç†</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 1em;">ğŸ”— ç›¸å…³é“¾æ¥</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <a href="https://github.com/${settings.githubUser}/${settings.githubRepo}" target="_blank" 
                           style="color: #667eea; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ“¦</span> GitHub ä»“åº“
                        </a>
                        <a href="https://github.com/${settings.githubUser}/${settings.githubRepo}/issues" target="_blank" 
                           style="color: #667eea; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                            <span>ï¿½</span> é—®é¢˜åé¦ˆ
                        </a>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 15px; border-top: 2px solid #e9ecef;">
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 5px;">ğŸ“„ MIT License</div>
                    <div style="color: #667eea; font-size: 1.1em; font-weight: 600;">æ„Ÿè°¢ä½¿ç”¨ï¼ğŸ‰</div>
                </div>
            `;

            showModal('â„¹ï¸ å…³äº', content);
        }

        // åŠ è½½å·¥ä½œæ—¶é—´çº¿ï¼ˆåŸºäº Git æäº¤è®°å½•ï¼‰
        async function loadWorkTimeline() {
            const timelineDiv = document.getElementById('workTimeline');

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                timelineDiv.innerHTML = '<div class="work-item"><div class="time">â³</div><div class="desc">æ­£åœ¨åŠ è½½å·¥ä½œè®°å½•...</div></div>';

                // è·å–ä»Šæ—¥çš„ Git æäº¤è®°å½•
                const commits = await fetchTodayCommits();

                // æ·»åŠ å·¥ä½œå¼€å§‹æ ‡è®°
                const workStart = getWorkStartTime();
                const timeline = [];

                if (workStart) {
                    timeline.push({
                        time: workStart,
                        desc: 'âœ… å¼€å§‹ä»Šæ—¥å·¥ä½œ',
                        timestamp: parseTimeToTimestamp(workStart)
                    });
                }

                // æ·»åŠ æäº¤è®°å½•
                commits.forEach(commit => {
                    const commitTime = new Date(commit.commit.author.date);
                    const timeStr = commitTime.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    const message = commit.commit.message.split('\n')[0]; // åªå–ç¬¬ä¸€è¡Œ

                    let desc = `ğŸ“ ${message}`;
                    
                    // æ·»åŠ é¡¹ç›®åç§°ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (commit.project) {
                        desc = `ğŸ“ [${commit.project}] ${message}`;
                    }
                    
                    // æ·»åŠ ä»£ç ç»Ÿè®¡
                    if (commit.stats) {
                        const insertions = commit.stats.insertions || 0;
                        const deletions = commit.stats.deletions || 0;
                        desc += `<br><span style="color: #28a745;">+${insertions}</span> <span style="color: #dc3545;">-${deletions}</span>`;
                    }
                    
                    // æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
                    if (commit.files && commit.files.length > 0) {
                        desc += `<br><span style="color: #999; font-size: 0.85em;">ğŸ“ ${commit.files.join(', ')}</span>`;
                    }

                    timeline.push({
                        time: timeStr,
                        desc: desc,
                        timestamp: commitTime.getTime(),
                        author: commit.commit.author.name,
                        sha: commit.sha
                    });
                });

                // æ·»åŠ ä¼‘æ¯æ—¶é—´æ ‡è®°
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                // åˆé¤æ—¶é—´ 12:30
                if (currentHour >= 12 || (currentHour === 12 && currentMinute >= 30)) {
                    const hasLunchBreak = timeline.some(item => item.time === '12:30');
                    if (!hasLunchBreak) {
                        timeline.push({
                            time: '12:30',
                            desc: 'ğŸ± åˆé¤ä¼‘æ¯',
                            timestamp: parseTimeToTimestamp('12:30')
                        });
                    }
                }

                // ä¸‹åˆä¸Šç­ 14:00
                if (currentHour >= 14) {
                    const hasAfternoonStart = timeline.some(item => item.time === '14:00');
                    if (!hasAfternoonStart) {
                        timeline.push({
                            time: '14:00',
                            desc: 'â˜• ä¸‹åˆå·¥ä½œå¼€å§‹',
                            timestamp: parseTimeToTimestamp('14:00')
                        });
                    }
                }

                // ä¸‹ç­æ—¶é—´ 18:30
                if (currentHour >= 18 && currentMinute >= 30) {
                    timeline.push({
                        time: '18:30',
                        desc: 'ğŸ  ä¸‹ç­ï¼Œä»Šæ—¥å·¥ä½œå®Œæˆ',
                        timestamp: parseTimeToTimestamp('18:30')
                    });
                }

                // æŒ‰æ—¶é—´æ’åº
                timeline.sort((a, b) => a.timestamp - b.timestamp);

                // æ¸²æŸ“æ—¶é—´çº¿
                if (timeline.length === 0) {
                    timelineDiv.innerHTML = `
                        <div class="work-item">
                            <div class="time">â„¹ï¸</div>
                            <div class="desc">ä»Šæ—¥æš‚æ— å·¥ä½œè®°å½•</div>
                        </div>
                        <div class="work-item">
                            <div class="time">ğŸ’¡</div>
                            <div class="desc">æç¤ºï¼šå·¥ä½œè®°å½•åŸºäº Git æäº¤è®°å½•è‡ªåŠ¨ç”Ÿæˆ</div>
                        </div>
                    `;
                } else {
                    timelineDiv.innerHTML = timeline.map(item => {
                        let desc = item.desc;
                        if (item.author && item.sha) {
                            desc += `<br><span style="color: #999; font-size: 0.85em;">ğŸ‘¤ ${item.author} | ğŸ“Œ ${item.sha}</span>`;
                        }
                        return `
                            <div class="work-item">
                                <div class="time">${item.time}</div>
                                <div class="desc">${desc}</div>
                            </div>
                        `;
                    }).join('');

                    // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                    const commitCount = commits.length;
                    if (commitCount > 0) {
                        timelineDiv.innerHTML += `
                            <div class="work-item" style="background: #f0f7ff; border-left: 3px solid #667eea;">
                                <div class="time">ğŸ“Š</div>
                                <div class="desc">
                                    <strong>ä»Šæ—¥ç»Ÿè®¡</strong><br>
                                    <span style="color: #667eea;">âœ… ${commitCount} æ¬¡æäº¤ | â° ${calculateWorkDuration(timeline)} å·¥ä½œæ—¶é•¿</span>
                                </div>
                            </div>
                        `;
                    }
                }

            } catch (error) {
                console.error('åŠ è½½å·¥ä½œè®°å½•å¤±è´¥:', error);
                timelineDiv.innerHTML = `
                    <div class="work-item">
                        <div class="time">âš ï¸</div>
                        <div class="desc">åŠ è½½å·¥ä½œè®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
                    </div>
                    <div class="work-item">
                        <div class="time">ğŸ’¡</div>
                        <div class="desc">å»ºè®®ï¼šåœ¨ç»ˆç«¯è¿è¡Œ <code>git log --since="today" --pretty=format:"%h - %s (%cr)"</code> æŸ¥çœ‹ä»Šæ—¥æäº¤</div>
                    </div>
                `;
            }
        }

        // è·å–ä»Šæ—¥çš„æäº¤è®°å½•
        async function fetchTodayCommits() {
            // ä¼˜å…ˆä»åç«¯APIè·å–çœŸå®Gitæäº¤å†å²
            try {
                const response = await fetch('http://localhost:5178/api/commits/today');
                if (response.ok) {
                    const data = await response.json();
                    if (data.commits) {
                        console.log('âœ… ä»Šæ—¥æäº¤è®°å½•ï¼ˆçœŸå®æ•°æ®ï¼‰:', data.commits);
                        // è½¬æ¢ä¸ºGitHub APIæ ¼å¼ä»¥ä¿æŒå…¼å®¹æ€§
                        return data.commits.map(c => ({
                            sha: c.hash,
                            commit: {
                                message: c.message,
                                author: {
                                    name: c.author,
                                    email: c.email,
                                    date: c.date
                                }
                            },
                            stats: {
                                insertions: c.insertions,
                                deletions: c.deletions,
                                total: c.insertions + c.deletions
                            },
                            files: c.changedFiles || [],
                            project: c.project
                        }));
                    }
                }
            } catch (error) {
                console.warn('åç«¯APIè·å–ä»Šæ—¥æäº¤å¤±è´¥ï¼Œå°è¯•GitHub API:', error);
            }

            // å¦‚æœåç«¯å¤±è´¥ï¼Œå›é€€åˆ°GitHub API
            const settings = getSettings();
            const owner = settings.githubUser;
            const repo = settings.githubRepo;
            const token = settings.githubToken;
            const today = new Date().toISOString().split('T')[0];

            try {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };

                // å¦‚æœæœ‰ tokenï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                const response = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/commits?since=${today}T00:00:00Z`,
                    { headers }
                );

                if (!response.ok) {
                    throw new Error('GitHub API è¯·æ±‚å¤±è´¥');
                }

                const commits = await response.json();
                return commits;
            } catch (error) {
                console.error('è·å–æäº¤è®°å½•å¤±è´¥:', error);
                // è¿”å›æœ¬åœ°ç¼“å­˜çš„æ•°æ®
                const cached = localStorage.getItem('todayCommits');
                if (cached) {
                    return JSON.parse(cached);
                }
                return [];
            }
        }

        // è·å–å·¥ä½œå¼€å§‹æ—¶é—´
        function getWorkStartTime() {
            const now = new Date();
            const currentHour = now.getHours();

            // å¦‚æœå½“å‰æ—¶é—´åœ¨ä¸Šç­æ—¶é—´ä¹‹åï¼Œè¿”å›ä¸Šç­æ—¶é—´
            if (currentHour >= 9) {
                return '09:30';
            }
            return null;
        }

        // å°†æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼ˆä»Šæ—¥ï¼‰
        function parseTimeToTimestamp(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date.getTime();
        }

        // è®¡ç®—å·¥ä½œæ—¶é•¿
        function calculateWorkDuration(timeline) {
            if (timeline.length < 2) {
                return 'è®¡ç®—ä¸­...';
            }

            const firstTime = timeline[0].timestamp;
            const lastTime = timeline[timeline.length - 1].timestamp;
            const duration = (lastTime - firstTime) / (1000 * 60 * 60); // è½¬æ¢ä¸ºå°æ—¶

            // å‡å»åˆé¤æ—¶é—´ï¼ˆå¦‚æœè·¨è¶Šäº†12:30-14:00ï¼‰
            let workHours = duration;
            const lunchStart = parseTimeToTimestamp('12:30');
            const lunchEnd = parseTimeToTimestamp('14:00');

            if (firstTime < lunchStart && lastTime > lunchEnd) {
                workHours -= 1.5; // å‡å»1.5å°æ—¶åˆé¤æ—¶é—´
            }

            return workHours > 0 ? workHours.toFixed(1) + ' å°æ—¶' : '0 å°æ—¶';
        }

        // èŠå¤©åŠŸèƒ½
        // ==================== AI å¯¹è¯åŠŸèƒ½ ====================

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.value = '';

            // ç¦ç”¨å‘é€æŒ‰é’®
            const sendBtn = document.querySelector('.chat-send-btn');
            sendBtn.disabled = true;

            try {
                // å°è¯•è°ƒç”¨çœŸå® AI API
                const settings = getSettings();
                let reply;

                if (settings.aiProvider && settings.aiApiKey) {
                    // ä½¿ç”¨çœŸå® AI API
                    console.log('ğŸ¤– ä½¿ç”¨çœŸå® AI API:', settings.aiProvider);
                    sendBtn.textContent = `è¯·æ±‚ ${settings.aiProvider} ä¸­...`;
                    reply = await getAIApiReply(message, settings);
                    console.log('âœ… AI API å“åº”æˆåŠŸ');
                } else {
                    // ä½¿ç”¨å†…ç½®è§„åˆ™å›å¤
                    console.log('ğŸ’¬ ä½¿ç”¨å†…ç½®è§„åˆ™å›å¤');
                    sendBtn.textContent = 'æ€è€ƒä¸­...';
                    reply = await getSmartReply(message);
                }

                addMessage('assistant', reply);
            } catch (error) {
                console.error('âŒ AI å›å¤å¤±è´¥:', error);
                let errorMsg = 'æŠ±æ­‰ï¼ŒAI æœåŠ¡å‡ºç°é—®é¢˜ï¼š\n\n';
                
                if (error.message.includes('API é”™è¯¯')) {
                    errorMsg += `â€¢ ${error.message}\n`;
                    errorMsg += 'â€¢ è¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®\n';
                    errorMsg += 'â€¢ è¯·ç¡®è®¤è´¦æˆ·ä½™é¢å……è¶³\n\n';
                } else {
                    errorMsg += `â€¢ ${error.message}\n\n`;
                }
                
                errorMsg += 'ğŸ’¡ ä½ å¯ä»¥ï¼š\n';
                errorMsg += '1. é‡æ–°é…ç½® AI è®¾ç½®\n';
                errorMsg += '2. ç»§ç»­ä½¿ç”¨å†…ç½®åŠŸèƒ½\n';
                errorMsg += '3. æ£€æŸ¥ç½‘ç»œè¿æ¥';
                
                addMessage('assistant', errorMsg);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
            }
        }

        // è°ƒç”¨çœŸå® AI API
        async function getAIApiReply(message, settings) {
            const { aiProvider, aiApiKey, aiModel } = settings;

            // æ„å»ºä¸Šä¸‹æ–‡ï¼šåŒ…å«å½“å‰å·¥ä½œæ•°æ®
            const context = buildContext();
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€ä¸“ä¸šçš„ AI ç¼–ç¨‹åŠ©æ‰‹ã€‚ä½ å¯ä»¥è®¿é—®ç”¨æˆ·çš„å·¥ä½œæ•°æ®ï¼š
${context}

è¯·åŸºäºè¿™äº›çœŸå®æ•°æ®å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å›ç­”è¦ç®€æ´ã€æœ‰å¸®åŠ©ï¼Œå¹¶åœ¨åˆé€‚æ—¶ä½¿ç”¨ emojiã€‚`;

            try {
                if (aiProvider === 'copilot') {
                    return await callGitHubCopilot(message, systemPrompt, aiApiKey);
                } else if (aiProvider === 'openai') {
                    return await callOpenAI(message, systemPrompt, aiApiKey, aiModel);
                } else if (aiProvider === 'claude') {
                    return await callClaude(message, systemPrompt, aiApiKey, aiModel);
                } else if (aiProvider === 'gemini') {
                    return await callGemini(message, systemPrompt, aiApiKey, aiModel);
                } else if (aiProvider === 'local') {
                    return await callLocalAI(message, systemPrompt, settings.aiEndpoint);
                }
            } catch (error) {
                console.error('AI API è°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // GitHub Copilot API
        async function callGitHubCopilot(message, systemPrompt, token = 'auto') {
            // GitHub Copilot é€šè¿‡ VS Code æ’ä»¶ä½¿ç”¨ï¼Œæ²¡æœ‰ç›´æ¥çš„ HTTP API
            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ GitHub Models API (é¢„è§ˆç‰ˆ) æˆ– OpenAI æ ¼å¼
            
            console.log('ğŸ” ä½¿ç”¨ GitHub Token è°ƒç”¨ AI...');
            
            // æ–¹æ¡ˆ1: ä½¿ç”¨ GitHub ç”¨æˆ·çš„ gist æ–¹å¼ï¼ˆå®éªŒæ€§ï¼‰
            // æ–¹æ¡ˆ2: ç›´æ¥æç¤ºç”¨æˆ·ä½¿ç”¨ OpenAI API
            // æ–¹æ¡ˆ3: ä½¿ç”¨ GitHub Copilot é€šè¿‡ VS Code APIï¼ˆéœ€è¦æ’ä»¶ï¼‰
            
            // å½“å‰é‡‡ç”¨ï¼šæç¤ºç”¨æˆ· GitHub Copilot éœ€è¦é€šè¿‡ VS Code ä½¿ç”¨
            throw new Error(
                'âš ï¸ GitHub Copilot æš‚ä¸æ”¯æŒç›´æ¥ API è°ƒç”¨\n\n' +
                'ğŸ’¡ GitHub Copilot åªèƒ½é€šè¿‡ VS Code æ’ä»¶ä½¿ç”¨ã€‚\n\n' +
                'æ¨èæ›¿ä»£æ–¹æ¡ˆï¼š\n' +
                '1. ä½¿ç”¨ OpenAI APIï¼ˆCopilot åº•å±‚ä¹Ÿæ˜¯ OpenAIï¼‰\n' +
                '   â€¢ è®¿é—® https://platform.openai.com/api-keys\n' +
                '   â€¢ åˆ›å»º API Key å¹¶é…ç½®\n\n' +
                '2. ä½¿ç”¨å…¶ä»– AI æœåŠ¡ï¼š\n' +
                '   â€¢ Claude (Anthropic)\n' +
                '   â€¢ Google Gemini\n' +
                '   â€¢ æœ¬åœ° AI (Ollama)\n\n' +
                '3. ç»§ç»­ä½¿ç”¨å†…ç½®æ™ºèƒ½å›å¤åŠŸèƒ½'
            );
        }

        // OpenAI API
        async function callOpenAI(message, systemPrompt, apiKey, model = 'gpt-3.5-turbo') {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: message }
                    ],
                    temperature: 0.7,
                    max_tokens: 500
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API é”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Claude API
        async function callClaude(message, systemPrompt, apiKey, model = 'claude-3-haiku-20240307') {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: 500,
                    system: systemPrompt,
                    messages: [
                        { role: 'user', content: message }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`Claude API é”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // Google Gemini API
        async function callGemini(message, systemPrompt, apiKey, model = 'gemini-pro') {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `${systemPrompt}\n\nç”¨æˆ·é—®é¢˜: ${message}`
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API é”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // æœ¬åœ° AIï¼ˆOllama ç­‰ï¼‰
        async function callLocalAI(message, systemPrompt, endpoint = 'http://localhost:11434/api/generate') {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama2',
                    prompt: `${systemPrompt}\n\nç”¨æˆ·: ${message}\nåŠ©æ‰‹:`,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`æœ¬åœ° AI é”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            return data.response;
        }

        // æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
        function buildContext() {
            const commits = document.getElementById('commits')?.textContent || '0';
            const insertions = document.getElementById('insertions')?.textContent || '0';
            const deletions = document.getElementById('deletions')?.textContent || '0';
            const workHours = document.getElementById('work-hours')?.textContent || '0';

            return `- ä»Šæ—¥æäº¤: ${commits} æ¬¡
- æ–°å¢ä»£ç : ${insertions} è¡Œ
- åˆ é™¤ä»£ç : ${deletions} è¡Œ
- å·¥ä½œæ—¶é•¿: ${workHours} å°æ—¶
- å½“å‰æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
        }

        // ç®€åŒ–ç‰ˆï¼šåªæç¤ºé…ç½® AI
        async function getSmartReply(message) {
            // æ¨¡æ‹Ÿæ€è€ƒå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            return 'ğŸ’¡ è¯·é…ç½®çœŸå® AI æœåŠ¡ä»¥è·å¾—æ™ºèƒ½å¯¹è¯ã€‚\n\n' +
                   'ï¿½ ç‚¹å‡»å·¦ä¾§ "ğŸ¤– AI å¯¹è¯é…ç½®" é€‰æ‹©ï¼š\n' +
                   'â€¢ OpenAI GPTï¼ˆæ¨èï¼Œ$ï¼‰\n' +
                   'â€¢ Google Geminiï¼ˆå…è´¹â­ï¼‰\n' +
                   'â€¢ Claude (Anthropic, $)\n' +
                   'â€¢ æœ¬åœ° AI (Ollama,ğŸ”’)\n\n' +
                   'é…ç½®åå³å¯è¿›è¡ŒçœŸå®çš„ AI å¯¹è¯ï¼';
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const roleDiv = document.createElement('div');
            roleDiv.className = 'role';
            roleDiv.textContent = role === 'user' ? 'ğŸ‘¤ ä½ ' : 'ğŸ¤– AI åŠ©ç†';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            contentDiv.textContent = content;

            messageDiv.appendChild(roleDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>

    <!-- è‡ªå®šä¹‰å¼¹æ¡† -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ğŸ” æ ‡é¢˜</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥ -->
            </div>
            
        </div>
    </div>
</body>

</html>